<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NEXUS TERMINAL v0.31</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a25;
      --bg-hover: #252535;
      --panel-bg: #0f0f16;
      --text-primary: #e0e0e0;
      --text-secondary: #888;
      --text-muted: #555;
      --accent: #00d4ff;
      --accent-dim: #00a0cc;
      --accent-glow: rgba(0, 212, 255, 0.3);
      --success: #00ff88;
      --warning: #ffaa00;
      --error: #ff4466;
      --border: #2a2a3a;
      --user-bg: #1a2a35;
      --assistant-bg: #151520;
    }
    body {
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse-glow {
      0% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.4); }
      70% { box-shadow: 0 0 0 8px rgba(0, 255, 136, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); }
    }
    .header {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      gap: 12px;
      flex-shrink: 0;
    }
    .menu-toggle {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
    }
    .menu-toggle:hover { color: var(--accent); }
    .logo {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: 2px;
      text-transform: uppercase;
    }
    .header-spacer { flex: 1; }
    .indicator-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 11px;
      border-radius: 6px;
      font-size: 11px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }
    .indicator-chip:hover { border-color: var(--accent); background: var(--bg-hover); }
    .indicator-chip .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--text-muted);
    }
    .indicator-chip.connected .dot { background: var(--success); }
    .indicator-chip.modified .dot { background: var(--warning); }
    .indicator-chip.error .dot { background: var(--error); }
    .icon-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      width: 28px; height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .icon-btn:hover { border-color: var(--accent); color: var(--accent); }
    .icon-btn.has-heartbeat {
      animation: pulse-glow 2s infinite;
      border-color: var(--success);
      color: var(--success);
    }
    .settings-panel {
      display: none;
      padding: 15px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border);
    }
    .settings-panel.visible { display: block; }
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
    }
    .setting-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .setting-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
    }
    .setting-input, .setting-select {
      padding: 9px 11px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 5px;
      color: var(--text-primary);
      font-size: 12px;
      font-family: inherit;
    }
    .setting-input:focus, .setting-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .sidebar {
      width: 300px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transition: width 0.3s;
      flex-shrink: 0;
    }
    .sidebar.collapsed { width: 0; border-right: none; overflow: hidden; }
    .sidebar-content {
      padding: 15px;
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .sidebar-section-header {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      padding-bottom: 5px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }
    .sidebar-section-header .toggle-icon { transition: transform 0.2s; }
    .sidebar-section-header.collapsed .toggle-icon { transform: rotate(-90deg); }
    .sidebar-section-content {
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: all 0.3s;
    }
    .sidebar-section-content.collapsed {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      pointer-events: none;
    }
    .hint {
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
      padding: 10px;
    }
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .welcome-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 40px;
    }
    .welcome-logo {
      font-size: 36px;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 5px;
      margin-bottom: 12px;
    }
    .welcome-version {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 30px;
    }
    .welcome-text {
      font-size: 14px;
      color: var(--text-secondary);
      max-width: 520px;
      line-height: 1.7;
      margin-bottom: 40px;
    }
    .api-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      max-width: 400px;
    }
    .api-form-input {
      padding: 12px 15px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 13px;
      text-align: center;
    }
    .api-form-btn {
      padding: 12px 24px;
      background: var(--accent);
      border: none;
      border-radius: 6px;
      color: var(--bg-primary);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .api-form-btn:hover { background: var(--accent-dim); }
    .input-container {
      padding: 15px 20px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }
    .shelf-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 10px;
      color: var(--text-muted);
    }
    .input-wrapper {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }
    .message-input {
      flex: 1;
      padding: 12px 15px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 13px;
      font-family: inherit;
      resize: none;
      min-height: 48px;
      max-height: 200px;
      line-height: 1.5;
    }
    .message-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }
    .send-btn {
      padding: 12px 20px;
      background: var(--accent);
      border: none;
      border-radius: 6px;
      color: var(--bg-primary);
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .send-btn:hover { background: var(--accent-dim); }
    .toast {
      position: fixed;
      right: 20px;
      bottom: 90px;
      background: rgba(0,0,0,0.9);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 12px;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      backdrop-filter: blur(6px);
    }
    .toast.visible { opacity: 1; }
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal-overlay.visible { display: flex; }
    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      width: 100%;
      max-width: 700px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
    }
    .modal-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
    }
    .modal-close:hover { color: var(--error); }
    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    .message { max-width: 85%; animation: fadeIn 0.3s; }
    .message.user { align-self: flex-end; }
    .message.assistant { align-self: flex-start; }
    .message-header { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 6px; }
    .message.user .message-header { color: var(--accent); justify-content: flex-end; }
    .message-content { padding: 12px 16px; border-radius: 8px; border: 1px solid var(--border); }
    .message.user .message-content { background: var(--user-bg); }
    .message.assistant .message-content { background: var(--assistant-bg); }
    .thinking-block { margin: 10px 0; border: 1px solid #2a1a3a; border-radius: 6px; background: #1a1520; overflow: hidden; }
    .thinking-header { padding: 8px 12px; background: rgba(100,50,150,0.2); cursor: pointer; font-size: 11px; color: #aa88cc; display: flex; justify-content: space-between; }
    .thinking-content { padding: 12px; font-size: 12px; color: var(--text-secondary); display: none; max-height: 300px; overflow-y: auto; }
    .thinking-content.expanded { display: block; }
    .code-block-header { display: flex; justify-content: space-between; padding: 6px 12px; background: var(--bg-hover); font-size: 11px; color: var(--text-muted); }
    .copy-btn { background: none; border: 1px solid var(--border); color: var(--text-secondary); padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 10px; }
    .copy-btn:hover { border-color: var(--accent); color: var(--accent); }
    .sidebar-item { padding: 8px 10px; border-radius: 4px; cursor: pointer; transition: all 0.15s; }
    .sidebar-item:hover { background: var(--bg-tertiary); }
    .sidebar-item.active { background: var(--bg-hover); color: var(--accent); }
    .sidebar-item.agent-item.due { border-left: 3px solid var(--warning); }
    .command-item { padding: 6px 10px; background: var(--bg-tertiary); border-radius: 4px; display: flex; justify-content: space-between; cursor: pointer; }
    .command-item:hover { background: var(--bg-hover); }
    .cmd-desc { color: var(--text-muted); font-size: 10px; }
  </style>
</head>
<body>
  <div class="header">
    <button class="menu-toggle" id="menuToggle">☰</button>
    <div class="logo">NEXUS v0.31</div>
    <div class="header-spacer"></div>
    <div class="indicator-chip" id="providerChip">
      <div class="dot"></div>
      <span>Setup Required</span>
    </div>
    <div class="indicator-chip" id="promptChip">
      <div class="dot"></div>
      <span>Kernel + Standard</span>
    </div>
    <button class="icon-btn" id="powerBtn" title="Power Panel">⚡</button>
    <button class="icon-btn" id="helpBtn" title="Help">?</button>
    <button class="icon-btn" id="settingsToggle">⚙</button>
  </div>
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-grid">
      <div class="setting-group">
        <label class="setting-label">Provider</label>
        <select class="setting-select" id="providerSelect">
          <option value="auto" selected>Auto-Detect</option>
          <option value="anthropic">Anthropic</option>
          <option value="openai">OpenAI</option>
          <option value="groq">Groq</option>
          <option value="gemini">Google Gemini</option>
          <option value="openrouter">OpenRouter</option>
          <option value="xai">xAI</option>
        </select>
      </div>
      <div class="setting-group">
        <label class="setting-label">API Key</label>
        <input type="password" class="setting-input" id="apiKeyInput" placeholder="sk-...">
      </div>
      <div class="setting-group">
        <label class="setting-label">Model</label>
        <input type="text" class="setting-input" id="modelInput" placeholder="e.g. claude-sonnet-4-5">
      </div>
      <div class="setting-group">
        <label class="setting-label">Max Tokens</label>
        <input type="number" class="setting-input" id="maxTokensInput" value="8192">
      </div>
      <div class="setting-group">
        <label class="setting-label">CORS Proxy (Optional)</label>
        <select class="setting-select" id="corsProxySelect">
            <option value="none">None (Direct)</option>
            <option value="corsproxy">corsproxy.io (Public)</option>
        </select>
      </div>
    </div>
  </div>
  <div class="main-container">
    <div class="sidebar" id="sidebar">
      <div class="sidebar-content">
        <div class="sidebar-section">
          <div class="sidebar-section-header" id="agentsHeader">
            <span>Active Agents</span>
            <span class="toggle-icon">▼</span>
          </div>
          <div class="sidebar-section-content" id="agentsContent">
            <div class="hint">No agents running</div>
          </div>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-header" id="commandsHeader">
            <span>Commands</span>
            <span class="toggle-icon">▼</span>
          </div>
          <div class="sidebar-section-content" id="commandsContent">
            <div class="hint">Loading commands...</div>
          </div>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-header" id="packsHeader">
            <span>Knowledge Packs</span>
            <span class="toggle-icon">▼</span>
          </div>
          <div class="sidebar-section-content" id="packsContent">
            <div class="hint">Load packs via Power Panel</div>
          </div>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-header" id="sessionsHeader">
            <span>Sessions</span>
            <span class="toggle-icon">▼</span>
          </div>
          <div class="sidebar-section-content" id="sessionsContent">
            <div class="hint">Loading...</div>
          </div>
        </div>
      </div>
    </div>
    <div class="chat-container">
      <div class="chat-messages" id="chatMessages">
        <div class="welcome-screen">
          <div class="welcome-logo">NEXUS</div>
          <div class="welcome-version">v0.31 — Full 2025 Provider Support</div>
          <div class="welcome-text">
            A local-first, agentic AI terminal with persistent knowledge.
            <br><br>
            <em style="font-size:12px; color:var(--text-muted)">Now supports latest Claude Sonnet 4.5, Gemini 2.5, etc.</em>
          </div>
          <div class="api-form">
            <input type="password" class="api-form-input" id="welcomeApiKey" placeholder="Enter your API key to begin">
            <button class="api-form-btn" id="welcomeConnectBtn">Connect</button>
          </div>
        </div>
      </div>
      <div class="toast" id="toast"></div>
      <div class="input-container">
        <div class="shelf-bar">
          <span id="shelfSummary">0 pinned items</span>
          <span id="tokenCount">~0 context tokens</span>
        </div>
        <div class="input-wrapper">
          <textarea class="message-input" id="messageInput" placeholder="Enter message... (Shift+Enter for new line)"></textarea>
          <button class="send-btn" id="sendBtn">Send</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="promptModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Prompt Stack</div>
        <button class="modal-close" id="promptClose">×</button>
      </div>
      <div class="modal-body">
        <pre id="promptPreview" style="white-space: pre-wrap; font-family: inherit; color: var(--text-secondary);"></pre>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="powerModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Power Panel</div>
        <button class="modal-close" id="powerClose">×</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-muted);">Loading controls...</p>
      </div>
    </div>
  </div>
  <script>
    (() => {
      'use strict';
      const $ = (id) => document.getElementById(id);
      const el = {
        menuToggle: $('menuToggle'),
        sidebar: $('sidebar'),
        providerChip: $('providerChip'),
        promptChip: $('promptChip'),
        powerBtn: $('powerBtn'),
        settingsToggle: $('settingsToggle'),
        settingsPanel: $('settingsPanel'),
        providerSelect: $('providerSelect'),
        apiKeyInput: $('apiKeyInput'),
        modelInput: $('modelInput'),
        maxTokensInput: $('maxTokensInput'),
        corsProxySelect: $('corsProxySelect'),
        welcomeApiKey: $('welcomeApiKey'),
        welcomeConnectBtn: $('welcomeConnectBtn'),
        messageInput: $('messageInput'),
        sendBtn: $('sendBtn'),
        toast: $('toast'),
        shelfSummary: $('shelfSummary'),
        tokenCount: $('tokenCount'),
        chatMessages: $('chatMessages'),
        sessionsContent: $('sessionsContent'),
        packsContent: $('packsContent'),
        commandsContent: $('commandsContent'),
        agentsContent: $('agentsContent'),
        promptModal: $('promptModal'),
        promptPreview: $('promptPreview'),
        powerModal: $('powerModal'),
        welcomeScreen: document.querySelector('.welcome-screen'),
      };
      const state = {
        booted: false,
        db: null,
        currentSession: null,
        abortController: null,
        isStreaming: false,
        agents: [],
        config: {
          provider: 'auto',
          model: 'claude-sonnet-4-5', // Current default alias (Dec 2025)
          apiKey: '',
          maxTokens: 8192,
          sourcesText: '',
          corsProxy: 'none',
        },
        currentDate: '2025-12-15',
        packs: [],
        itemIndex: new Map(),
      };
      const DB_NAME = 'nexus-v0.31';
      const DB_VERSION = 1;
      const db = {
        async open() {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (e) => {
              const db = e.target.result;
              ['config', 'sessions', 'cache', 'agents'].forEach(name => {
                if (!db.objectStoreNames.contains(name)) {
                  db.createObjectStore(name, { keyPath: name === 'config' ? 'key' : 'id' });
                }
              });
            };
            request.onsuccess = (e) => { state.db = e.target.result; resolve(); };
            request.onerror = (e) => reject(e.target.error);
          });
        },
        async get(store, key) {
          return new Promise(r => {
            const req = state.db.transaction(store).objectStore(store).get(key);
            req.onsuccess = () => r(req.result);
          });
        },
        async put(store, item) {
          return new Promise((resolve, reject) => {
            const req = state.db.transaction(store, 'readwrite').objectStore(store).put(item);
            req.onsuccess = () => resolve();
            req.onerror = (e) => reject(e.target.error);
          });
        },
        async list(store, opts = {}) {
          return new Promise(r => {
            const results = [];
            const req = state.db.transaction(store).objectStore(store).openCursor(null, 'prev');
            req.onsuccess = e => {
              const c = e.target.result;
              if (c && (!opts.limit || results.length < opts.limit)) {
                results.push(c.value);
                c.continue();
              } else r(results);
            };
          });
        },
      };
      function toast(msg, dur = 3000) {
        el.toast.textContent = msg;
        el.toast.classList.add('visible');
        setTimeout(() => el.toast.classList.remove('visible'), dur);
      }
      function autosize() {
        el.messageInput.style.height = 'auto';
        el.messageInput.style.height = Math.min(el.messageInput.scrollHeight, 200) + 'px';
      }
      function escapeHtml(str) {
        return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
      }
      function generateId() { return crypto.randomUUID(); }
      function estimateTokens(text) { return Math.ceil((text || '').length / 4); }
      function scrollToBottom() { el.chatMessages.scrollTop = el.chatMessages.scrollHeight; }
      function formatDate(iso) {
        return new Date(iso).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
      }
      function getPinnedItems() {
        return state.currentSession?.context?.pinned || [];
      }
      function composeSystemPrompt() {
        let prompt = `You are Nexus Terminal v0.31, a local-first AI assistant.
Today is ${state.currentDate}.
Be concise, honest, and capable.
`;
        const overlayId = state.currentSession?.overlayId || 'standard';
        if (overlayId !== 'standard') {
          const item = state.itemIndex.get(overlayId);
          if (item) {
            prompt += `=== OVERLAY: ${item.title} ===\n${item.body}\n\n`;
          }
        }
        const pinned = getPinnedItems();
        if (pinned.length > 0) {
          prompt += `=== CONTEXT SHELF (Pinned by user) ===\n`;
          pinned.forEach(uid => {
            const item = state.itemIndex.get(uid);
            if (item) prompt += `\n-- ${item.title} --\n${item.body}\n`;
          });
        }
        return prompt.trim();
      }
      function detectProvider(key) {
        key = key.trim();
        if (key.startsWith('sk-ant')) return 'anthropic';
        if (key.startsWith('sk-or')) return 'openrouter';
        if (key.startsWith('gsk_')) return 'groq';
        if (key.startsWith('xai-')) return 'xai';
        if (key.startsWith('AIza')) return 'gemini';
        if (key.startsWith('sk-')) return 'openai';
        return 'auto';
      }
      function getDefaultModel(provider) {
        if (provider === 'groq') return 'llama-3.3-70b-versatile';
        if (provider === 'openai') return 'gpt-4o';
        if (provider === 'anthropic') return 'claude-sonnet-4-5'; // Current alias for latest Sonnet 4.5
        if (provider === 'xai') return 'grok-3';
        if (provider === 'gemini') return 'gemini-2.5-flash';
        return 'claude-sonnet-4-5';
      }
      async function fetchPack(url) {
        const cached = await db.get('cache', url);
        if (cached && Date.now() - cached.fetchedAt < 3600000) {
          return cached.data;
        }
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          await db.put('cache', { url, fetchedAt: Date.now(), data });
          return data;
        } catch (e) {
          toast(`Failed to load pack: ${url}`);
          return null;
        }
      }
      async function loadPacks() {
        const urls = state.config.sourcesText.split('\n').map(u => u.trim()).filter(Boolean);
        const loaded = [];
        for (const url of urls) {
          const data = await fetchPack(url);
          if (data) loaded.push({ ...data, sourceUrl: url });
        }
        const corePack = {
          id: 'nexus:core',
          name: 'Nexus Core',
          version: '1.0',
          items: [
            { kind: 'overlay', id: 'standard', title: 'Standard Assistant', body: 'You are a helpful, direct assistant.' },
            { kind: 'overlay', id: 'coder', title: 'Senior Engineer', body: 'You are an expert software engineer. Provide clean, efficient code with explanations.' },
            { kind: 'overlay', id: 'writer', title: 'Creative Writer', body: 'You are a skilled writer. Use vivid, engaging language.' },
            { kind: 'command', id: 'help', title: '/help', body: 'Show available commands and usage' },
            { kind: 'command', id: 'status', title: '/status', body: 'Show current system status' },
          ]
        };
        loaded.push(corePack);
        state.packs = loaded;
        rebuildItemIndex();
        renderPacksList();
        updateShelfUI();
        toast(`Loaded ${loaded.length} pack${loaded.length === 1 ? '' : 's'}`);
      }
      function rebuildItemIndex() {
        state.itemIndex.clear();
        for (const pack of state.packs) {
          for (const item of pack.items || []) {
            const uid = `${pack.id}::${item.kind}::${item.id}`;
            state.itemIndex.set(uid, { ...item, uid, packName: pack.name, packVersion: pack.version });
          }
        }
      }
      function renderPacksList() {
        if (state.packs.length === 0) {
          el.packsContent.innerHTML = '<div class="hint">No packs loaded</div>';
          return;
        }
        el.packsContent.innerHTML = state.packs.map(p => `
          <div class="sidebar-item">
            <div>${escapeHtml(p.name || 'Unknown')}</div>
            <div class="meta">v${escapeHtml(p.version || '?')} • ${p.items?.length || 0} items</div>
          </div>
        `).join('');
      }
      async function pinItem(uid) {
        if (!state.currentSession) return;
        state.currentSession.context = state.currentSession.context || { pinned: [] };
        if (!state.currentSession.context.pinned.includes(uid)) {
          state.currentSession.context.pinned.push(uid);
          await saveCurrentSession();
          updateShelfUI();
          toast('Pinned to context shelf');
        }
      }
      async function unpinItem(uid) {
        if (!state.currentSession) return;
        state.currentSession.context.pinned = state.currentSession.context.pinned.filter(u => u !== uid);
        await saveCurrentSession();
        updateShelfUI();
        toast('Unpinned from shelf');
      }
      function updateShelfUI() {
        const pinned = getPinnedItems();
        el.shelfSummary.textContent = `${pinned.length} pinned item${pinned.length === 1 ? '' : 's'}`;
        let shelfText = '';
        pinned.forEach(uid => {
          const item = state.itemIndex.get(uid);
          if (item) shelfText += item.body + '\n\n';
        });
        el.tokenCount.textContent = `~${estimateTokens(shelfText)} context tokens`;
      }
      function updatePromptChip() {
        const overlayId = state.currentSession?.overlayId || 'standard';
        const item = state.itemIndex.get(overlayId);
        const name = item?.title || 'Standard';
        el.promptChip.querySelector('span').textContent = `Kernel + ${name}`;
      }
      function updateProviderChip() {
        const hasKey = !!state.config.apiKey;
        el.providerChip.classList.toggle('connected', hasKey);
        el.providerChip.classList.toggle('error', !hasKey);
        el.providerChip.querySelector('span').textContent = hasKey
          ? `${state.config.provider === 'auto' ? 'Auto-Detect' : state.config.provider.toUpperCase()} Ready`
          : 'Setup Required';
      }
      async function createNewSession() {
        try {
          const newSession = {
            id: generateId(),
            title: `Session ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            messages: [],
            overlayId: 'standard',
            context: { pinned: [] },
          };
          await db.put('sessions', newSession);
          state.currentSession = newSession;
          await renderSessionsList();
          renderChatArea();
          renderMessages();
          updateShelfUI();
          toast('New session created');
        } catch (e) {
          console.error("Failed to create session:", e);
          toast("DB Error: " + e.message);
          throw e;
        }
      }
      async function loadSession(id) {
        const session = await db.get('sessions', id);
        if (!session) return toast('Session not found');
        state.currentSession = session;
        await renderSessionsList();
        renderChatArea();
        renderMessages();
        updateShelfUI();
        updatePromptChip();
        toast(`Loaded: ${session.title}`);
      }
      async function saveCurrentSession() {
        if (!state.currentSession) return;
        state.currentSession.updatedAt = new Date().toISOString();
        await db.put('sessions', state.currentSession);
        await renderSessionsList();
      }
      async function renderSessionsList() {
        const sessions = await db.list('sessions', { limit: 20 });
        if (sessions.length === 0) {
          el.sessionsContent.innerHTML = '<div class="hint">No saved sessions</div>';
          return;
        }
        el.sessionsContent.innerHTML = sessions.map(s => {
          const active = state.currentSession && s.id === state.currentSession.id;
          return `
            <div class="sidebar-item ${active ? 'active' : ''}" onclick="loadSession('${s.id}')">
              <div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(s.title)}</div>
              <div class="meta">${formatDate(s.updatedAt)}</div>
            </div>
          `;
        }).join('');
      }
      function renderChatArea() {
        if (state.config.apiKey && state.currentSession) {
          el.welcomeScreen.style.display = 'none';
        } else {
          el.welcomeScreen.style.display = 'flex';
        }
      }
      async function loadConfig() {
        const saved = await db.get('config', 'main');
        if (saved) {
          state.config = { ...state.config, ...saved };
        }
        el.providerSelect.value = state.config.provider;
        el.modelInput.value = state.config.model;
        el.maxTokensInput.value = state.config.maxTokens;
        el.apiKeyInput.value = state.config.apiKey || '';
        el.corsProxySelect.value = state.config.corsProxy || 'none';
        updateProviderChip();
        renderChatArea();
      }
      async function saveConfig() {
        state.config.provider = el.providerSelect.value;
        state.config.model = el.modelInput.value.trim() || getDefaultModel(state.config.provider);
        state.config.maxTokens = parseInt(el.maxTokensInput.value) || 8192;
        state.config.apiKey = el.apiKeyInput.value.trim();
        state.config.corsProxy = el.corsProxySelect.value;
        state.config.sourcesText = document.getElementById('sourcesInput')?.value || state.config.sourcesText;
        await db.put('config', { key: 'main', ...state.config });
        updateProviderChip();
        renderChatArea();
        await loadPacks();
      }
      marked.setOptions({
        highlight: code => hljs.highlightAuto(code).value,
        breaks: true,
        gfm: true
      });
      function renderMarkdown(text) {
        if (!text) return '';
        let html = marked.parse(text);
        html = html.replace(/<pre><code class="language-([^"]+)">/g, '<pre><div class="code-block-header"><span>$1</span><button class="copy-btn">Copy</button></div><code class="language-$1">');
        html = html.replace(/<pre><code>/g, '<pre><div class="code-block-header"><span>code</span><button class="copy-btn">Copy</button></div><code>');
        return html;
      }
      function renderMessage(msg) {
        const isUser = msg.role === 'user';
        let thinkingHtml = '';
        if (msg.thinking) {
          thinkingHtml = `
            <div class="thinking-block">
              <div class="thinking-header">Thinking Process <span class="toggle-icon">▼</span></div>
              <div class="thinking-content expanded">${escapeHtml(msg.thinking)}</div>
            </div>
          `;
        }
        return `
          <div class="message ${isUser ? 'user' : 'assistant'}">
            <div class="message-header">${isUser ? 'You' : 'Nexus'}</div>
            <div class="message-content">
              ${thinkingHtml}
              ${renderMarkdown(msg.content || '')}
            </div>
          </div>
        `;
      }
      function renderMessages() {
        if (!state.currentSession) return;
        el.chatMessages.innerHTML = state.currentSession.messages.length === 0
          ? '<div class="hint">Chat ready. Type a message or use a command.</div>'
          : state.currentSession.messages.map(renderMessage).join('');
        addCopyHandlers();
        addThinkingToggles();
        scrollToBottom();
      }
      function addCopyHandlers() {
        document.querySelectorAll('.copy-btn').forEach(btn => {
          btn.onclick = () => {
            const code = btn.closest('pre').querySelector('code').textContent;
            navigator.clipboard.writeText(code);
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy', 2000);
          };
        });
      }
      function addThinkingToggles() {
        document.querySelectorAll('.thinking-header').forEach(header => {
          header.onclick = () => {
            const content = header.nextElementSibling;
            content.classList.toggle('expanded');
            header.querySelector('.toggle-icon').textContent = content.classList.contains('expanded') ? '▼' : '▶';
          };
        });
      }
      async function sendMessage() {
        const text = el.messageInput.value.trim();
        if (!text || state.isStreaming) return;
        const userMsg = { role: 'user', content: text };
        state.currentSession.messages.push(userMsg);
        el.messageInput.value = '';
        autosize();
        renderMessages();
        await saveCurrentSession();
        const assistantMsg = { role: 'assistant', content: '', thinking: '' };
        state.currentSession.messages.push(assistantMsg);
        renderMessages();
        state.isStreaming = true;
        el.sendBtn.disabled = true;
        state.abortController = new AbortController();
        try {
          const apiMessages = state.currentSession.messages.filter(m => m.role !== 'assistant' || m.content);
          const system = composeSystemPrompt();
          let url;
          let body;
          let headers = {
             'content-type': 'application/json',
          };
          let effectiveProvider = state.config.provider;
          let effectiveModel = state.config.model.trim();
          let effectiveMaxTokens = parseInt(state.config.maxTokens) || 8192;
          if (effectiveProvider === 'auto') {
             effectiveProvider = detectProvider(state.config.apiKey);
          }
          if (!effectiveModel) effectiveModel = getDefaultModel(effectiveProvider);

          // Provider-specific model enforcement
          const modelLower = effectiveModel.toLowerCase();
          if (effectiveProvider === 'anthropic') {
            // Remove old Claude 3 patterns, force to current Sonnet 4.5 alias
            if (modelLower.includes('claude-3') || modelLower.includes('2024')) {
              effectiveModel = 'claude-sonnet-4-5';
            }
          }
          if (effectiveProvider === 'gemini') {
            if (modelLower.includes('1.5')) {
              effectiveModel = effectiveModel.replace(/1\.5/g, '2.5');
            }
            if (!modelLower.includes('2.5')) {
              effectiveModel = getDefaultModel('gemini');
            }
          }

          // Sync changes back
          if (effectiveModel !== state.config.model) {
            state.config.model = effectiveModel;
            el.modelInput.value = effectiveModel;
          }

          if (effectiveProvider === 'anthropic') {
            url = 'https://api.anthropic.com/v1/messages';
            headers['x-api-key'] = state.config.apiKey;
            headers['anthropic-version'] = '2023-06-01';
            headers['anthropic-dangerous-direct-browser-access'] = 'true';
            body = {
              model: effectiveModel,
              system,
              messages: apiMessages.map(m => ({ role: m.role, content: m.content })),
              max_tokens: effectiveMaxTokens,
              stream: true,
            };
          } else if (effectiveProvider === 'gemini') {
            let cleanModel = effectiveModel.replace(/^models\//, '').trim();
            url = `https://generativelanguage.googleapis.com/v1beta/models/${cleanModel}:streamGenerateContent?alt=sse&key=${state.config.apiKey}`;
            const contents = apiMessages.map(m => ({
              role: m.role === 'assistant' ? 'model' : 'user',
              parts: [{ text: m.content }]
            }));
            body = {
              contents: contents,
              system_instruction: { parts: [{ text: system }] },
              generation_config: { max_output_tokens: effectiveMaxTokens }
            };
          } else {
            url = 'https://api.openai.com/v1/chat/completions';
            if (effectiveProvider === 'groq') url = 'https://api.groq.com/openai/v1/chat/completions';
            if (effectiveProvider === 'openrouter') {
                url = 'https://openrouter.ai/api/v1/chat/completions';
                headers['HTTP-Referer'] = window.location.href;
            }
            if (effectiveProvider === 'xai') url = 'https://api.x.ai/v1/chat/completions';
            headers['Authorization'] = `Bearer ${state.config.apiKey}`;
            body = {
              model: effectiveModel,
              messages: [{ role: 'system', content: system }, ...apiMessages.map(m => ({ role: m.role, content: m.content }))],
              max_tokens: effectiveMaxTokens,
              stream: true,
            };
          }
          if (state.config.corsProxy === 'corsproxy') {
            url = 'https://corsproxy.io/?' + encodeURIComponent(url);
          }
          const res = await fetch(url, {
            method: 'POST',
            headers,
            body: JSON.stringify(body),
            signal: state.abortController.signal,
          });
          if (!res.ok) throw new Error(await res.text() || res.statusText);
          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            for (const line of lines) {
              if (!line.startsWith('data: ')) continue;
              const data = line.slice(6);
              if (data === '[DONE]') continue;
              try {
                const event = JSON.parse(data);
                if (effectiveProvider === 'anthropic') {
                  if (event.type === 'content_block_delta' && event.delta.type === 'text_delta') {
                    assistantMsg.content += event.delta.text;
                  }
                } else if (effectiveProvider === 'gemini') {
                   const text = event.candidates?.[0]?.content?.parts?.[0]?.text;
                   if (text) assistantMsg.content += text;
                } else {
                  const delta = event.choices?.[0]?.delta?.content;
                  if (delta) assistantMsg.content += delta;
                }
              } catch {}
            }
            renderMessages();
          }
        } catch (err) {
          if (err.name !== 'AbortError') {
            let errorText = `[Error: ${err.message}]`;
            if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
                errorText += `\n\n**Possible fix:** Browser CORS block. Enable "CORS Proxy" in settings or use OpenRouter.`;
            } else if (err.message.includes('not_found_error') || err.message.includes('not found')) {
                errorText += `\n\n**Model Fix:** Old model name detected. Updated to latest (e.g. claude-sonnet-4-5 for Anthropic).`;
            }
            assistantMsg.content += `\n\n${errorText}`;
            toast('Transmission failed');
          }
        } finally {
          state.isStreaming = false;
          el.sendBtn.disabled = false;
          state.abortController = null;
          await saveCurrentSession();
          renderMessages();
        }
      }
      const COMMANDS = [
        { id: 'help', title: '/help', desc: 'Show available commands', action: 'chat', prompt: '/help' },
        { id: 'status', title: '/status', desc: 'Show system status', action: 'chat', prompt: '/status' },
        { id: 'new', title: '/new', desc: 'Start new session', action: 'silent', execute: async () => await createNewSession() },
        { id: 'clear', title: '/clear', desc: 'Clear current session', action: 'silent', execute: async () => {
          if (confirm('Clear all messages?')) {
            state.currentSession.messages = [];
            await saveCurrentSession();
            renderMessages();
            toast('Session cleared');
          }
        }},
        { id: 'overlay-standard', title: 'Overlay: Standard', desc: 'Default mode', action: 'silent', execute: async () => {
          state.currentSession.overlayId = 'standard';
          await saveCurrentSession();
          updatePromptChip();
          toast('Overlay: Standard');
        }},
        { id: 'overlay-coder', title: 'Overlay: Coder', desc: 'Engineer mode', action: 'silent', execute: async () => {
          state.currentSession.overlayId = 'nexus:core::overlay::coder';
          await saveCurrentSession();
          updatePromptChip();
          toast('Overlay: Senior Engineer');
        }},
        { id: 'overlay-writer', title: 'Overlay: Writer', desc: 'Creative mode', action: 'silent', execute: async () => {
          state.currentSession.overlayId = 'nexus:core::overlay::writer';
          await saveCurrentSession();
          updatePromptChip();
          toast('Overlay: Creative Writer');
        }},
      ];
      async function executeCommand(cmd) {
        if (cmd.action === 'chat') {
          el.messageInput.value = cmd.prompt;
          autosize();
          await sendMessage();
        } else if (cmd.action === 'silent' && cmd.execute) {
          await cmd.execute();
        }
      }
      function renderCommands() {
        el.commandsContent.innerHTML = COMMANDS.map(cmd => `
          <div class="command-item" data-id="${cmd.id}">
            <span class="cmd-title">${escapeHtml(cmd.title)}</span>
            <span class="cmd-desc">${escapeHtml(cmd.desc)}</span>
          </div>
        `).join('');
        document.querySelectorAll('.command-item').forEach(item => {
          item.onclick = () => {
            const cmd = COMMANDS.find(c => c.id === item.dataset.id);
            if (cmd) executeCommand(cmd);
          };
        });
      }
      async function loadAgents() {
        state.agents = await db.list('agents');
        renderAgents();
        updatePowerHeartbeat();
      }
      async function saveAgents() {
        for (const agent of state.agents) await db.put('agents', agent);
      }
      function renderAgents() {
        if (state.agents.length === 0) {
          el.agentsContent.innerHTML = '<div class="hint">No active agents</div>';
          return;
        }
        el.agentsContent.innerHTML = state.agents.map(a => `
          <div class="sidebar-item agent-item ${a.status === 'due' ? 'due' : ''}">
            <div>${escapeHtml(a.title)}</div>
            <div class="meta">${a.schedule}</div>
            <button class="icon-btn" onclick="runAgent('${a.id}')">▶</button>
          </div>
        `).join('');
      }
      async function runAgent(id) {
        const agent = state.agents.find(a => a.id === id);
        if (!agent) return;
        let prompt = `[Agent: ${agent.title}]\nReady to execute.`;
        if (agent.title.toLowerCase().includes('summarize')) {
          const recent = state.currentSession.messages.slice(-15).map(m => `${m.role}: ${m.content}`).join('\n');
          prompt = `[Agent: ${agent.title}]\nSummarize this conversation:\n\n${recent}`;
        }
        el.messageInput.value = prompt;
        autosize();
        await sendMessage();
        if (agent.schedule !== 'once') {
          agent.nextRun = Date.now() + (agent.schedule === 'hourly' ? 3600000 : 86400000);
        } else {
          state.agents = state.agents.filter(a => a.id !== id);
        }
        await saveAgents();
        renderAgents();
      }
      function updatePowerHeartbeat() {
        el.powerBtn.classList.toggle('has-heartbeat', state.agents.length > 0);
      }
      function checkAgentSchedule() {
        const now = Date.now();
        state.agents.forEach(a => {
          if (a.nextRun <= now) a.status = 'due';
        });
        renderAgents();
      }
      function setupPowerPanel() {
        el.powerModal.querySelector('.modal-body').innerHTML = `
          <div class="setting-group">
            <label class="setting-label">Knowledge Pack Sources (one URL per line)</label>
            <textarea class="setting-input" id="sourcesInput" rows="6">${state.config.sourcesText}</textarea>
            <button class="api-form-btn" id="refreshPacksBtn">Refresh Packs</button>
          </div>
          <div class="setting-group" style="margin-top:20px;">
            <label class="setting-label">Spawn New Agent</label>
            <input class="setting-input" id="newAgentTitle" placeholder="e.g. Daily Summarizer">
            <select class="setting-select" id="newAgentSchedule">
              <option value="once">Once</option>
              <option value="hourly">Hourly</option>
              <option value="daily">Daily</option>
            </select>
            <button class="api-form-btn" id="spawnAgentBtn">Spawn Agent</button>
          </div>
        `;
        $('refreshPacksBtn').onclick = async () => {
          state.config.sourcesText = $('sourcesInput').value;
          await saveConfig();
        };
        $('spawnAgentBtn').onclick = async () => {
          const title = $('newAgentTitle').value.trim();
          if (!title) return toast('Enter title');
          const schedule = $('newAgentSchedule').value;
          const agent = {
            id: generateId(),
            title,
            schedule,
            nextRun: schedule === 'once' ? Date.now() : Date.now() + (schedule === 'hourly' ? 3600000 : 86400000),
            status: 'waiting',
          };
          state.agents.push(agent);
          await saveAgents();
          renderAgents();
          updatePowerHeartbeat();
          $('newAgentTitle').value = '';
          toast(`Agent "${title}" spawned`);
        };
      }
      function wireEvents() {
        el.menuToggle.onclick = () => el.sidebar.classList.toggle('collapsed');
        el.settingsToggle.onclick = () => el.settingsPanel.classList.toggle('visible');
        el.providerChip.onclick = () => el.settingsPanel.classList.toggle('visible');
        el.promptChip.onclick = () => {
          el.promptPreview.textContent = composeSystemPrompt();
          el.promptModal.classList.add('visible');
        };
        el.powerBtn.onclick = () => el.powerModal.classList.add('visible');
        document.querySelectorAll('.modal-close').forEach(btn => btn.onclick = () => btn.closest('.modal-overlay').classList.remove('visible'));
        document.querySelectorAll('.modal-overlay').forEach(ov => ov.onclick = e => { if (e.target === ov) ov.classList.remove('visible'); });
        el.welcomeConnectBtn.onclick = async () => {
          try {
            const key = el.welcomeApiKey.value.trim();
            if (key) {
              const detected = detectProvider(key);
              let model = getDefaultModel(detected);
              el.providerSelect.value = 'auto';
              el.modelInput.value = model;
              el.apiKeyInput.value = key;
              el.maxTokensInput.value = 8192;
              await saveConfig();
              if (!state.currentSession) await createNewSession();
              renderChatArea();
              toast(`Connected (${detected.toUpperCase()})`);
            } else {
              toast('Please enter a valid API key');
            }
          } catch (error) {
            console.error(error);
            toast('Connection failed: ' + error.message);
          }
        };
        el.welcomeApiKey.onkeydown = async (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            el.welcomeConnectBtn.click();
          }
        };
        el.apiKeyInput.addEventListener('input', async () => {
          const key = el.apiKeyInput.value.trim();
          const provider = detectProvider(key);
          if (provider !== 'auto') {
            const recommended = getDefaultModel(provider);
            el.modelInput.value = recommended;
            await saveConfig();
          }
        });
        el.providerSelect.onchange = saveConfig;
        el.modelInput.oninput = saveConfig;
        el.maxTokensInput.oninput = saveConfig;
        el.apiKeyInput.oninput = saveConfig;
        el.corsProxySelect.onchange = saveConfig;
        el.sendBtn.onclick = sendMessage;
        el.messageInput.onkeydown = e => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        };
        el.messageInput.oninput = autosize;
        document.querySelectorAll('.sidebar-section-header').forEach(h => {
          h.onclick = () => {
            h.classList.toggle('collapsed');
            h.nextElementSibling.classList.toggle('collapsed');
          };
        });
      }
      async function boot() {
        try {
            await db.open();
            await loadConfig();
            await loadPacks();
            await loadAgents();
            const sessions = await db.list('sessions', { limit: 1 });
            if (sessions.length) await loadSession(sessions[0].id);
            else if (state.config.apiKey) await createNewSession();
            await renderSessionsList();
            renderPacksList();
            renderCommands();
            renderAgents();
            renderChatArea();
            renderMessages();
            updateShelfUI();
            updatePromptChip();
            setupPowerPanel();
            wireEvents();
            setInterval(checkAgentSchedule, 30000);
            checkAgentSchedule();
            toast('Nexus Terminal v0.31 — All providers fixed for Dec 2025', 5000);
        } catch (err) {
            console.error(err);
            toast('Boot failed: ' + err.message);
        }
      }
      boot();
    })();
  </script>
</body>
</html>
