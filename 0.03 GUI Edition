<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NEXUS TERMINAL v0.50 (Notebook Edition)</title>
  
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.css" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>

  <style>
    /* --- CSS RESET & VARIABLES (Strict Fidelity v0.41) --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a25;
      --bg-hover: #252535;
      --panel-bg: #0f0f16;
      --text-primary: #e0e0e0;
      --text-secondary: #888;
      --text-muted: #555;
      --accent: #00d4ff;
      --accent-dim: #00a0cc;
      --accent-glow: rgba(0, 212, 255, 0.3);
      --success: #00ff88;
      --warning: #ffaa00;
      --error: #ff4466;
      --border: #2a2a3a;
      --user-bg: #1a2a35;
      --assistant-bg: #151520;
    }
    body {
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.4); border-color: var(--success); } 70% { box-shadow: 0 0 0 6px rgba(0, 255, 136, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); border-color: var(--success); } }
    
    .header { display: flex; align-items: center; padding: 12px 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); gap: 12px; flex-shrink: 0; }
    .logo { font-size: 14px; font-weight: 600; color: var(--accent); letter-spacing: 2px; text-transform: uppercase; margin-right: 15px; }
    .layout-controls { display: flex; gap: 5px; }
    .layout-btn { background: none; border: 1px solid var(--border); color: var(--text-muted); width: 32px; height: 32px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .layout-btn:hover { color: var(--text-primary); border-color: var(--accent); }
    .header-spacer { flex: 1; }
    .indicator-chip { display: flex; align-items: center; gap: 6px; padding: 5px 11px; border-radius: 6px; font-size: 11px; background: var(--bg-tertiary); border: 1px solid var(--border); cursor: pointer; transition: all 0.2s; }
    .indicator-chip .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); }
    .indicator-chip.connected .dot { background: var(--success); }
    .icon-btn { background: none; border: 1px solid var(--border); color: var(--text-secondary); width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .icon-btn:hover { border-color: var(--accent); color: var(--accent); }

    .settings-panel { display: none; padding: 15px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border); }
    .settings-panel.visible { display: block; }
    .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
    .setting-group { display: flex; flex-direction: column; gap: 5px; }
    .setting-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); }
    .setting-input, .setting-select { padding: 9px 11px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 5px; color: var(--text-primary); font-size: 12px; font-family: inherit; }

    .main-container { display: flex; flex: 1; overflow: hidden; }
    .sidebar { width: 280px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); flex-shrink: 0; overflow: hidden; }
    .sidebar.collapsed { width: 0; border-right: none; }
    .sidebar-content { padding: 15px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 18px; }
    
    .split-view { display: flex; flex: 1; overflow: hidden; position: relative; }
    .chat-pane { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
    .workspace-pane { width: 450px; background: var(--bg-secondary); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; transition: all 0.3s; position: relative; flex-shrink: 0; }
    .workspace-pane.collapsed { width: 0; border-left: none; }
    .workspace-header { padding: 12px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-tertiary); flex-shrink: 0; min-width: 450px; }
    .workspace-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); }
    .workspace-content { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: hidden; min-width: 450px; }
    .workspace-flex-grow { flex: 1; display: flex; flex-direction: column; min-height: 0; }
    .workspace-flex-grow textarea { flex: 1; resize: none; background: transparent; border: none; color: var(--text-primary); font-family: inherit; outline: none; }

    .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
    .input-container { padding: 15px 20px; background: var(--bg-secondary); border-top: 1px solid var(--border); flex-shrink: 0; }
    .message-input { flex: 1; padding: 12px 15px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 13px; font-family: inherit; resize: none; min-height: 48px; width: 100%; outline: none; }
    .message-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
    .send-btn { padding: 12px 20px; background: var(--accent); border: none; border-radius: 6px; color: var(--bg-primary); font-weight: 600; font-size: 12px; cursor: pointer; text-transform: uppercase; margin-left: 10px; }

    .message { max-width: 85%; animation: fadeIn 0.3s; }
    .message.user { align-self: flex-end; }
    .message.assistant { align-self: flex-start; }
    .message-header { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 6px; }
    .message-content { padding: 12px 16px; border-radius: 8px; border: 1px solid var(--border); line-height: 1.5; font-size: 13px; }
    .message.user .message-content { background: var(--user-bg); }
    .message.assistant .message-content { background: var(--assistant-bg); }

    /* Code & Notebook Styles */
    .code-block-header { display: flex; justify-content: space-between; padding: 6px 12px; background: var(--bg-hover); font-size: 11px; color: var(--text-muted); border-radius: 6px 6px 0 0; margin-top: 10px; }
    pre { margin: 0; border-radius: 0 0 6px 6px; border: 1px solid var(--border); border-top: none; }
    code { font-family: 'Fira Code', monospace; font-size: 12px; }
    .copy-btn { background: none; border: 1px solid var(--border); color: var(--text-secondary); padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 10px; }
    .copy-btn:hover { border-color: var(--accent); color: var(--accent); }
    
    .combo-console { display: flex; flex-direction: column; gap: 10px; height: 100%; }
    .drop-zone { flex: 1; background: var(--bg-tertiary); border: 2px dashed var(--border); border-radius: 6px; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; font-size: 12px; }
    .hint { color: var(--text-muted); text-align: center; margin-top: 20px; font-style: italic; }
    .toast { position: fixed; right: 20px; bottom: 90px; background: rgba(0,0,0,0.9); border: 1px solid var(--border); color: var(--text-primary); padding: 10px 16px; border-radius: 8px; font-size: 12px; z-index: 100; opacity: 0; transition: opacity 0.3s; pointer-events: none; backdrop-filter: blur(6px); }
    .toast.visible { opacity: 1; }
    
    /* Modals */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; z-index: 1000; }
    .modal-overlay.visible { display: flex; }
    .modal { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; width: 600px; max-width: 90%; padding: 20px; }
    .welcome-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 40px; }
  </style>
</head>
<body>

  <div class="header">
    <div class="logo">NEXUS v0.50</div>
    <div class="layout-controls">
      <button class="layout-btn" title="Toggle Sidebar" onclick="window.safeToggle('sidebar')">‚óß</button>
      <button class="layout-btn" title="Toggle Workspace" onclick="window.safeToggle('workspace')">‚ó®</button>
    </div>
    <div class="header-spacer"></div>
    <div class="indicator-chip" id="providerChip" title="Checking Engine...">
      <div class="dot"></div>
      <span id="providerText">Setup Required</span>
    </div>
    <button class="icon-btn" id="settingsToggle" title="Settings">‚öô</button>
  </div>

  <div class="settings-panel" id="settingsPanel">
    <div class="settings-grid">
      <div class="setting-group">
        <label class="setting-label">API Key</label>
        <input type="password" class="setting-input" id="apiKeyInput" placeholder="sk-...">
      </div>
      <div class="setting-group">
        <label class="setting-label">Provider</label>
        <select class="setting-select" id="providerSelect">
          <option value="auto">Auto-Detect</option>
          <option value="anthropic">Anthropic</option>
          <option value="openai">OpenAI</option>
          <option value="groq">Groq</option>
          <option value="openrouter">OpenRouter</option>
        </select>
      </div>
      <div class="setting-group">
        <label class="setting-label">Model</label>
        <input type="text" class="setting-input" id="modelInput" placeholder="claude-3-5-sonnet-20240620">
      </div>
      <div class="setting-group">
        <div style="display:flex; justify-content:space-between;">
           <button class="copy-btn" onclick="window.saveConfig()">SAVE CONFIG</button>
        </div>
      </div>
    </div>
  </div>

  <div class="main-container">
    <div class="sidebar" id="sidebar">
      <div class="sidebar-content">
        <div class="message-header">SESSIONS</div>
        <div id="sessionsContent" style="display:flex; flex-direction:column; gap:5px;">
           <div class="hint">No active sessions</div>
        </div>
      </div>
    </div>

    <div class="split-view">
      <div class="chat-pane" id="chatPane">
        <div class="chat-messages" id="chatMessages">
          <div class="welcome-screen">
            <div style="font-size:32px; font-weight:700; color:var(--accent); letter-spacing:4px; margin-bottom:10px;">NEXUS</div>
            <div style="color:var(--text-muted); margin-bottom:30px;">v0.50 ‚Äî Notebook Edition</div>
            <div style="max-width:400px; color:var(--text-secondary); line-height:1.6; margin-bottom:20px;">
              System Online. Neural Engine Initializing.<br>
              Enter API Key in settings to begin.
            </div>
            <button class="send-btn" onclick="document.getElementById('settingsToggle').click()">Configure Access</button>
          </div>
        </div>
        
        <div class="toast" id="toast"></div>
        
        <div class="input-container">
           <div style="display:flex;">
             <textarea class="message-input" id="messageInput" placeholder="Enter message or /solve expression..." onkeydown="window.handleChatKey(event)"></textarea>
             <button class="send-btn" onclick="window.sendMessage()">Send</button>
           </div>
        </div>
      </div>

      <div class="workspace-pane collapsed" id="workspacePane">
        <div class="workspace-header">
          <div class="workspace-title">Engineering Console</div>
          <button class="icon-btn" id="notebookToggle" title="Switch Mode" style="margin-left:auto; margin-right:10px;">‚ö°</button>
          <button class="icon-btn" onclick="window.closeWorkspace()">√ó</button>
        </div>
        <div class="workspace-content" id="workspaceContent">
          </div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      'use strict';
      const $ = (id) => document.getElementById(id);
      
      // --- 1. THE GHOST ENGINE (Pyodide Worker) ---
      const PYODIDE_WORKER_CODE = `
        importScripts("https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js");
        let pyodide = null, pyodideReady = false;

        // Matplotlib Trap: Render to Base64
        const plotPreamble = \`
import matplotlib
matplotlib.use("Agg")
import matplotlib.pyplot as plt
import io, base64
def show_hook():
    buf = io.BytesIO()
    plt.savefig(buf, format='png')
    buf.seek(0)
    img = 'data:image/png;base64,' + base64.b64encode(buf.read()).decode('utf-8')
    plt.clf()
    print("IMG::" + img)
plt.show = show_hook
\`;

        async function loadSystem() {
          try {
            pyodide = await loadPyodide();
            await pyodide.loadPackage(["micropip", "numpy", "matplotlib", "sympy"]);
            pyodide.FS.mount(pyodide.FS.filesystems.IDBFS, { root: "." }, "/persist");
            pyodide.FS.syncfs(true, () => {});
            await pyodide.runPythonAsync(plotPreamble);
            pyodideReady = true;
            postMessage({ type: 'status', status: 'ready' });
          } catch (e) { postMessage({ type: 'status', status: 'failed', error: e.toString() }); }
        }
        loadSystem();

        self.onmessage = async (e) => {
          const { id, code, action } = e.data;
          if (!pyodideReady) return postMessage({ id, type: 'error', error: 'Engine Warming Up...' });
          
          if (action === 'run') {
            try {
              pyodide.setStdout({ batched: (text) => postMessage({ id, type: 'print', text }) });
              await pyodide.loadPackagesFromImports(code);
              let res = await pyodide.runPythonAsync(code);
              pyodide.FS.syncfs(false, () => {});
              postMessage({ id, type: 'result', result: res ? res.toString() : '' });
            } catch (err) { postMessage({ id, type: 'error', error: err.toString() }); }
          }
        };
      `;

      // --- 2. STATE & DATABASE ---
      const state = {
        config: { provider: 'auto', apiKey: '', model: '', corsProxy: 'none' },
        currentSession: null,
        workspaceMode: 'engineer', // 'engineer' or 'notebook'
        pyodideWorker: null,
        pyodideReady: false,
        db: null
      };

      const DB_NAME = 'nexus-v0.50';
      const DB_VERSION = 4;

      const db = {
        async open() {
          return new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = (e) => {
              const d = e.target.result;
              ['config', 'sessions', 'cache', 'agents'].forEach(n => {
                if(!d.objectStoreNames.contains(n)) d.createObjectStore(n, { keyPath: n === 'config' ? 'key' : 'id' });
              });
              // SURGICAL IMPLANT: Notebook Store
              if(!d.objectStoreNames.contains('notebooks')) {
                const nb = d.createObjectStore('notebooks', { keyPath: 'id', autoIncrement: true });
                nb.createIndex('type', 'type');
                nb.createIndex('timestamp', 'timestamp');
              }
            };
            req.onsuccess = (e) => { state.db = e.target.result; resolve(); };
            req.onerror = reject;
          });
        },
        async put(store, item) {
          return new Promise(r => { 
            const tx = state.db.transaction(store, 'readwrite');
            tx.objectStore(store).put(item);
            tx.oncomplete = r;
          });
        },
        async get(store, key) {
          return new Promise(r => {
             const req = state.db.transaction(store).objectStore(store).get(key);
             req.onsuccess = () => r(req.result);
          });
        },
        async list(store, opts={}) {
          return new Promise(r => {
            const res = [];
            const req = state.db.transaction(store).objectStore(store).openCursor(null, 'prev');
            req.onsuccess = (e) => {
              const c = e.target.result;
              if(c && (!opts.limit || res.length < opts.limit)) { res.push(c.value); c.continue(); }
              else r(res);
            };
          });
        },
        async addNotebookEntry(entry) {
          const tx = state.db.transaction('notebooks', 'readwrite');
          const st = tx.objectStore('notebooks');
          if(!entry.timestamp) entry.timestamp = Date.now();
          st.add(entry);
          // Pruning
          const countReq = st.count();
          countReq.onsuccess = () => {
            if(countReq.result > 200) {
              st.getAllKeys().onsuccess = (e) => {
                 const keys = e.target.result;
                 const diff = keys.length - 200;
                 for(let i=0; i<diff; i++) st.delete(keys[i]);
              };
            }
          };
          return new Promise(r => tx.oncomplete = r);
        }
      };

      // --- 3. UI LOGIC ---
      function toast(msg, dur=3000) {
        const t = $('toast'); t.textContent = msg; t.classList.add('visible');
        setTimeout(() => t.classList.remove('visible'), dur);
      }

      function escapeHtml(str) { return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      function detectProvider(key) {
        if (key.startsWith('sk-ant')) return 'anthropic';
        if (key.startsWith('sk-or')) return 'openrouter';
        if (key.startsWith('sk-')) return 'openai';
        return 'auto';
      }

      window.saveConfig = async () => {
        state.config.apiKey = $('apiKeyInput').value.trim();
        state.config.provider = $('providerSelect').value;
        state.config.model = $('modelInput').value.trim();
        if(state.config.provider === 'auto') state.config.provider = detectProvider(state.config.apiKey);
        
        await db.put('config', { key: 'main', ...state.config });
        $('providerText').textContent = state.config.provider.toUpperCase();
        $('providerChip').classList.add('connected');
        toast('Configuration Saved');
        $('settingsPanel').classList.remove('visible');
        
        if(!$('chatMessages').querySelector('.message')) {
          $('chatMessages').innerHTML = ''; // Clear welcome
          state.currentSession = { id: crypto.randomUUID(), created: Date.now(), messages: [] };
          await db.put('sessions', state.currentSession);
        }
      };

      window.safeToggle = (id) => {
        const el = $(id);
        if(id === 'sidebar') el.classList.toggle('collapsed');
        if(id === 'workspace') {
           $('workspacePane').classList.toggle('collapsed');
           if(!$('workspacePane').classList.contains('collapsed')) window.renderWorkspaceUI();
        }
      };
      
      window.closeWorkspace = () => $('workspacePane').classList.add('collapsed');
      
      // --- 4. CHAMELEON WORKSPACE ---
      window.toggleWorkspaceMode = () => {
        state.workspaceMode = state.workspaceMode === 'engineer' ? 'notebook' : 'engineer';
        window.renderWorkspaceUI();
      };

      window.renderWorkspaceUI = async () => {
        const content = $('workspaceContent');
        const title = document.querySelector('.workspace-title');
        const toggleBtn = $('notebookToggle');
        
        content.innerHTML = '';
        toggleBtn.onclick = window.toggleWorkspaceMode;

        if (state.workspaceMode === 'engineer') {
           title.textContent = "ENGINEERING CONSOLE";
           title.style.color = "var(--accent)";
           toggleBtn.innerHTML = '‚ö°'; 
           
           const editor = document.createElement('div');
           editor.className = 'workspace-flex-grow';
           editor.innerHTML = `<textarea id="engineeringInput" placeholder="// Engineering Scratchpad..."></textarea>`;
           content.appendChild(editor);
           
           if(state.currentSession?.scratchpad) $('engineeringInput').value = state.currentSession.scratchpad;
           $('engineeringInput').oninput = (e) => {
              if(state.currentSession) {
                 state.currentSession.scratchpad = e.target.value;
                 db.put('sessions', state.currentSession);
              }
           };
        } else {
           title.textContent = "NEXUS NOTEBOOK";
           title.style.color = "var(--success)";
           toggleBtn.innerHTML = 'üìù';
           
           const container = document.createElement('div');
           container.className = 'combo-console';
           container.innerHTML = `
             <div id="notebookLog" class="drop-zone" style="background:#000; font-family:'Fira Code',monospace; cursor:default;"></div>
             <div style="display:flex; gap:10px;">
               <textarea id="replInput" class="message-input" rows="1" placeholder=">>> Python Code..." onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); window.runReplManual();}"></textarea>
               <button class="send-btn" onclick="window.runReplManual()">RUN</button>
             </div>
           `;
           content.appendChild(container);
           
           // Drag Targets
           const zone = $('notebookLog');
           zone.ondragover = (e) => { e.preventDefault(); zone.style.borderColor = 'var(--success)'; };
           zone.ondragleave = (e) => { e.preventDefault(); zone.style.borderColor = 'var(--border)'; };
           zone.ondrop = (e) => {
              e.preventDefault(); zone.style.borderColor = 'var(--border)';
              const raw = e.dataTransfer.getData('application/json');
              if(raw) {
                 try { const d = JSON.parse(raw); if(d.type==='code') $('replInput').value = d.content; } 
                 catch(e){}
              }
           };
           window.refreshNotebookLog();
        }
      };

      window.refreshNotebookLog = async () => {
         const log = $('notebookLog');
         if(!log) return;
         const entries = await db.list('notebooks', { limit: 50 });
         log.innerHTML = entries.length ? '' : '<div class="hint">Kernel Ready. Drag code here or type below.</div>';
         
         entries.reverse().forEach(entry => {
            const div = document.createElement('div');
            div.style.marginBottom = '10px'; div.style.borderBottom = '1px solid #222'; div.style.paddingBottom = '5px';
            const time = new Date(entry.timestamp).toLocaleTimeString();
            
            if(entry.type === 'code') div.innerHTML = `<div style="color:#555; font-size:10px;">IN [${time}]</div><div style="color:var(--accent); white-space:pre-wrap;">${escapeHtml(entry.content)}</div>`;
            if(entry.type === 'result') div.innerHTML = `<div style="color:#555; font-size:10px;">OUT [${time}]</div><div style="color:#e0e0e0; white-space:pre-wrap;">${escapeHtml(entry.content)}</div>`;
            if(entry.type === 'image') div.innerHTML = `<div style="color:#555; font-size:10px;">PLOT [${time}]</div><img src="${entry.content}" style="max-width:100%; margin-top:5px; border-radius:4px;">`;
            
            log.appendChild(div);
         });
         log.scrollTop = log.scrollHeight;
      };

      window.runReplManual = () => {
         const txt = $('replInput').value.trim();
         if(!txt) return;
         $('replInput').value = '';
         db.addNotebookEntry({ type: 'code', content: txt });
         toast('Sending to Neural Engine...');
         state.pyodideWorker.postMessage({ id: 'manual-'+Date.now(), action: 'run', code: txt });
         window.refreshNotebookLog();
      };

      // --- 5. NEURO-LINK (Messaging) ---
      function addMessage(role, content) {
         const div = document.createElement('div');
         div.className = `message ${role}`;
         div.dataset.id = crypto.randomUUID();
         div.innerHTML = `
           <div class="message-header">${role === 'user' ? 'YOU' : 'NEXUS'}</div>
           <div class="message-content">${role === 'user' ? escapeHtml(content) : marked.parse(content)}</div>
         `;
         $('chatMessages').appendChild(div);
         $('chatMessages').scrollTop = $('chatMessages').scrollHeight;
         window.decorateChatMessages();
         return div;
      }

      window.handleChatKey = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); window.sendMessage(); } };

      window.sendMessage = async () => {
         const input = $('messageInput');
         const text = input.value.trim();
         if(!text) return;
         input.value = '';
         input.style.height = 'auto';
         
         addMessage('user', text);
         
         // 1. INTERCEPT: /solve
         if(text.startsWith('/solve ')) {
            const expr = text.replace('/solve ', '');
            const code = `from sympy import *; x,y,z,t = symbols('x y z t'); init_printing(); print(latex(${expr}))`;
            addMessage('assistant', '<span class="blink">_</span>');
            state.pyodideWorker.postMessage({ id: 'chat-'+Date.now(), action: 'run', code: code });
            return;
         }

         // 2. STANDARD: API Call
         if(!state.currentSession) return toast('Please configure API key first');
         state.currentSession.messages.push({ role: 'user', content: text });
         
         addMessage('assistant', '<span class="blink">_</span>');
         const lastMsg = document.querySelector('.message.assistant:last-child .message-content');
         
         try {
            let url='', headers={}, body={};
            const msgs = state.currentSession.messages.map(m => ({role: m.role, content: m.content}));
            
            if(state.config.provider === 'anthropic') {
               url = 'https://api.anthropic.com/v1/messages';
               headers = { 'x-api-key': state.config.apiKey, 'anthropic-version': '2023-06-01', 'content-type': 'application/json' };
               if(state.config.corsProxy !== 'none') url = 'https://corsproxy.io/?' + encodeURIComponent(url);
               body = { model: state.config.model, max_tokens: 4096, messages: msgs, stream: true };
            } else {
               url = 'https://api.openai.com/v1/chat/completions';
               headers = { 'Authorization': `Bearer ${state.config.apiKey}`, 'Content-Type': 'application/json' };
               body = { model: state.config.model || 'gpt-4o', messages: msgs, stream: true };
            }

            const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let fullText = '';
            
            while(true) {
               const { done, value } = await reader.read();
               if(done) break;
               const chunk = decoder.decode(value);
               const lines = chunk.split('\n');
               for(const line of lines) {
                  if(line.startsWith('data: ') && line !== 'data: [DONE]') {
                     try {
                        const json = JSON.parse(line.slice(6));
                        const delta = json.choices?.[0]?.delta?.content || json.delta?.text || '';
                        fullText += delta;
                        lastMsg.innerHTML = marked.parse(fullText);
                     } catch(e) {}
                  }
               }
               window.decorateChatMessages();
               $('chatMessages').scrollTop = $('chatMessages').scrollHeight;
            }
            
            state.currentSession.messages.push({ role: 'assistant', content: fullText });
            await db.put('sessions', state.currentSession);
            
         } catch(err) {
            lastMsg.innerHTML = `<span style="color:var(--error)">LINK FAILED: ${err.message}</span>`;
         }
      };

      // --- 6. DECORATORS & EVENT LISTENERS ---
      window.decorateChatMessages = () => {
         document.querySelectorAll('pre code').forEach(block => {
            const pre = block.parentElement;
            if(pre.previousElementSibling?.className === 'code-block-header') return;
            
            const isPy = (block.className||'').includes('python');
            const header = document.createElement('div');
            header.className = 'code-block-header';
            header.innerHTML = `
              <span>${isPy ? 'PYTHON' : 'CODE'}</span>
              <div style="display:flex; gap:5px;">
                 ${isPy ? `<button class="copy-btn" style="color:var(--success); border-color:var(--success);" onclick="window.runPySnippet(this)">‚ñ∂ RUN</button>` : ''}
                 <button class="copy-btn" onclick="navigator.clipboard.writeText(this.parentElement.parentElement.nextElementSibling.innerText)">COPY</button>
              </div>
            `;
            pre.parentNode.insertBefore(header, pre);
            
            if(isPy) {
               pre.draggable = true;
               pre.ondragstart = (e) => {
                  e.dataTransfer.setData('application/json', JSON.stringify({type: 'code', content: block.textContent}));
                  const ws = $('workspacePane');
                  if(!ws.classList.contains('collapsed')) ws.style.borderColor = 'var(--success)';
               };
               pre.ondragend = () => $('workspacePane').style.borderColor = 'var(--border)';
            }
         });
         
         if(window.renderMathInElement) {
            renderMathInElement($('chatMessages'), { delimiters: [{left:'$$', right:'$$', display:true}, {left:'\\(', right:'\\)', display:false}] });
         }
      };

      window.runPySnippet = (btn) => {
         const code = btn.parentElement.parentElement.nextElementSibling.innerText;
         if(state.workspaceMode !== 'notebook') {
             $('workspacePane').classList.remove('collapsed');
             state.workspaceMode = 'notebook';
             window.renderWorkspaceUI();
         }
         db.addNotebookEntry({ type: 'code', content: code });
         toast('Executing Snippet...');
         state.pyodideWorker.postMessage({ id: 'snip-'+Date.now(), action: 'run', code: code });
         window.refreshNotebookLog();
      };

      // --- 7. BOOT SEQUENCE ---
      async function boot() {
         await db.open();
         
         const config = await db.get('config', 'main');
         if(config) {
            state.config = config;
            $('apiKeyInput').value = config.apiKey || '';
            $('modelInput').value = config.model || '';
            $('providerSelect').value = config.provider || 'auto';
            if(config.apiKey) {
               $('providerText').textContent = (config.provider||'auto').toUpperCase();
               $('providerChip').classList.add('connected');
               $('chatMessages').innerHTML = ''; // Remove welcome
               // Load last session
               const sessions = await db.list('sessions', {limit:1});
               if(sessions.length) {
                  state.currentSession = sessions[0];
                  state.currentSession.messages.forEach(m => addMessage(m.role, m.content));
               } else {
                  state.currentSession = { id: crypto.randomUUID(), created: Date.now(), messages: [] };
                  await db.put('sessions', state.currentSession);
               }
            }
         }

         // Init Ghost Engine
         const blob = new Blob([PYODIDE_WORKER_CODE], {type: 'application/javascript'});
         state.pyodideWorker = new Worker(URL.createObjectURL(blob));
         state.pyodideWorker.onmessage = async (e) => {
            const { id, type, text, result, status } = e.data;
            if(type === 'status') {
               if(status === 'ready') {
                  state.pyodideReady = true;
                  $('providerChip').title = "Neural Engine: Online";
                  if(state.workspaceMode === 'notebook') window.refreshNotebookLog();
               }
            }
            if(type === 'print' || type === 'result') {
               const content = text || result;
               if(!content) return;
               if(content.startsWith('IMG::')) {
                  await db.addNotebookEntry({ type: 'image', content: content.replace('IMG::','') });
               } else {
                  await db.addNotebookEntry({ type: 'result', content: content });
               }
               if(state.workspaceMode === 'notebook') window.refreshNotebookLog();
               
               // Handle /solve chat response
               if(id.startsWith('chat-')) {
                  const last = document.querySelector('.message.assistant:last-child .message-content');
                  if(last) {
                     last.innerHTML = `$$${content}$$`;
                     window.decorateChatMessages();
                  }
               }
            }
         };

         $('settingsToggle').onclick = () => $('settingsPanel').classList.toggle('visible');
         window.decorateChatMessages();
      }

      boot();
    })();
  </script>
</body>
</html>
