<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NEXUS TERMINAL v0.41 (Linear Safe)</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    /* --- CSS RESET & VARIABLES --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a25;
      --bg-hover: #252535;
      --panel-bg: #0f0f16;
      --text-primary: #e0e0e0;
      --text-secondary: #888;
      --text-muted: #555;
      --accent: #00d4ff;
      --accent-dim: #00a0cc;
      --accent-glow: rgba(0, 212, 255, 0.3);
      --success: #00ff88;
      --warning: #ffaa00;
      --error: #ff4466;
      --border: #2a2a3a;
      --user-bg: #1a2a35;
      --assistant-bg: #151520;
    }
    body {
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.4); border-color: var(--success); } 70% { box-shadow: 0 0 0 6px rgba(0, 255, 136, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); border-color: var(--success); } }
   
    .header { display: flex; align-items: center; padding: 12px 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); gap: 12px; flex-shrink: 0; }
    .logo { font-size: 14px; font-weight: 600; color: var(--accent); letter-spacing: 2px; text-transform: uppercase; margin-right: 15px; }
    .layout-controls { display: flex; gap: 5px; }
    .layout-btn { background: none; border: 1px solid var(--border); color: var(--text-muted); width: 32px; height: 32px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .layout-btn:hover { color: var(--text-primary); border-color: var(--accent); }
    .layout-btn.active { background: var(--bg-hover); color: var(--accent); border-color: var(--accent); }
    .header-spacer { flex: 1; }
    .indicator-chip { display: flex; align-items: center; gap: 6px; padding: 5px 11px; border-radius: 6px; font-size: 11px; background: var(--bg-tertiary); border: 1px solid var(--border); cursor: pointer; transition: all 0.2s; }
    .indicator-chip:hover { border-color: var(--accent); background: var(--bg-hover); }
    .indicator-chip .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); }
    .indicator-chip.connected .dot { background: var(--success); }
    .indicator-chip.error .dot { background: var(--error); }
    .icon-btn { background: none; border: 1px solid var(--border); color: var(--text-secondary); width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .icon-btn:hover { border-color: var(--accent); color: var(--accent); }
    .icon-btn.active { background: var(--bg-hover); color: var(--accent); border-color: var(--accent); }
    .icon-btn.stop-btn { color: var(--error); border-color: var(--error); animation: fadeIn 0.2s; }
    .icon-btn.stop-btn:hover { background: rgba(255, 68, 102, 0.1); }
   
    .settings-panel { display: none; padding: 15px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border); }
    .settings-panel.visible { display: block; }
    .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
    .setting-group { display: flex; flex-direction: column; gap: 5px; }
    .setting-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center; }
    .auto-detect-link { cursor: pointer; color: var(--accent); font-weight: 600; font-size: 10px; padding: 2px 6px; border: 1px solid var(--accent-dim); border-radius: 4px; transition: all 0.2s; }
    .auto-detect-link:hover { background: var(--accent-dim); color: var(--bg-primary); }
    .setting-input, .setting-select, .setting-textarea { padding: 9px 11px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 5px; color: var(--text-primary); font-size: 12px; font-family: inherit; }
    .setting-textarea { resize: none; }
    .setting-input:focus, .setting-select:focus, .setting-textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
   
    .main-container { display: flex; flex: 1; overflow: hidden; }
    .sidebar { width: 280px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); flex-shrink: 0; overflow: hidden; }
    .sidebar.collapsed { width: 0; border-right: none; }
    .sidebar-content { padding: 15px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 18px; min-width: 280px; }
    .sidebar-section-header { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); padding-bottom: 5px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; }
    .sidebar-section-header .toggle-icon { transition: transform 0.2s; }
    .sidebar-section-header.collapsed .toggle-icon { transform: rotate(-90deg); }
    .sidebar-section-content { display: flex; flex-direction: column; gap: 6px; transition: all 0.3s; }
    .sidebar-section-content.collapsed { max-height: 0; opacity: 0; overflow: hidden; pointer-events: none; }
    .hint { font-size: 12px; color: var(--text-muted); text-align: center; padding: 10px; }
   
    .split-view { display: flex; flex: 1; overflow: hidden; position: relative; }
    .chat-pane { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
    .workspace-pane { width: 450px; background: var(--bg-secondary); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; flex-shrink: 0; }
    .workspace-pane.collapsed { width: 0; border-left: none; }
    .workspace-header { padding: 12px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-tertiary); flex-shrink: 0; min-width: 450px; }
    .workspace-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); }
    .workspace-content { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: hidden; min-width: 450px; }
    .workspace-flex-grow { flex: 1; display: flex; flex-direction: column; min-height: 0; }
    .workspace-flex-grow textarea { flex: 1; resize: none; }
   
    .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
    .welcome-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 40px; }
    .welcome-logo { font-size: 36px; font-weight: 700; color: var(--accent); letter-spacing: 5px; margin-bottom: 12px; }
    .welcome-version { font-size: 13px; color: var(--text-muted); margin-bottom: 30px; }
    .welcome-text { font-size: 14px; color: var(--text-secondary); max-width: 520px; line-height: 1.7; margin-bottom: 40px; }
    .api-form { display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 400px; }
    .api-form-input { padding: 12px 15px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 13px; text-align: center; }
    .api-form-btn { padding: 12px 24px; background: var(--accent); border: none; border-radius: 6px; color: var(--bg-primary); font-weight: 600; font-size: 13px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
    .api-form-btn:hover { background: var(--accent-dim); }
   
    .input-container { padding: 15px 20px; background: var(--bg-secondary); border-top: 1px solid var(--border); flex-shrink: 0; }
    .shelf-bar { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 10px; color: var(--text-muted); }
    .input-wrapper { display: flex; gap: 10px; align-items: flex-end; }
    .message-input { flex: 1; padding: 12px 15px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 13px; font-family: inherit; resize: none; min-height: 48px; max-height: 200px; line-height: 1.5; }
    .message-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
    .send-btn { padding: 12px 20px; background: var(--accent); border: none; border-radius: 6px; color: var(--bg-primary); font-weight: 600; font-size: 12px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
    .send-btn:hover { background: var(--accent-dim); }
   
    .toast { position: fixed; right: 20px; bottom: 90px; background: rgba(0,0,0,0.9); border: 1px solid var(--border); color: var(--text-primary); padding: 10px 16px; border-radius: 8px; font-size: 12px; z-index: 100; opacity: 0; transition: opacity 0.3s; pointer-events: none; backdrop-filter: blur(6px); }
    .toast.visible { opacity: 1; }
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-overlay.visible { display: flex; }
    .modal { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; width: 100%; max-width: 700px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--border); }
    .modal-title { font-size: 14px; font-weight: 600; color: var(--accent); letter-spacing: 1px; text-transform: uppercase; }
    .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 20px; cursor: pointer; }
    .modal-close:hover { color: var(--error); }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
   
    .message { max-width: 85%; animation: fadeIn 0.3s; }
    .message.user { align-self: flex-end; }
    .message.assistant { align-self: flex-start; }
    .message-header { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 6px; }
    .message.user .message-header { color: var(--accent); justify-content: flex-end; }
    .message-content { padding: 12px 16px; border-radius: 8px; border: 1px solid var(--border); }
    .message.user .message-content { background: var(--user-bg); }
    .message.assistant .message-content { background: var(--assistant-bg); }
    .thinking-block { margin: 10px 0; border: 1px solid #2a1a3a; border-radius: 6px; background: #1a1520; overflow: hidden; }
    .thinking-header { padding: 8px 12px; background: rgba(100,50,150,0.2); cursor: pointer; font-size: 11px; color: #aa88cc; display: flex; justify-content: space-between; }
    .thinking-content { padding: 12px; font-size: 12px; color: var(--text-secondary); display: none; max-height: 300px; overflow-y: auto; }
    .thinking-content.expanded { display: block; }
    .code-block-header { display: flex; justify-content: space-between; padding: 6px 12px; background: var(--bg-hover); font-size: 11px; color: var(--text-muted); }
    .copy-btn { background: none; border: 1px solid var(--border); color: var(--text-secondary); padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 10px; }
    .copy-btn:hover { border-color: var(--accent); color: var(--accent); }
   
    .sidebar-item { padding: 8px 10px; border-radius: 4px; cursor: pointer; transition: all 0.15s; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; }
    .sidebar-item:hover { background: var(--bg-tertiary); }
    .sidebar-item.active-item { background: var(--bg-hover); color: var(--success); border-color: var(--success); box-shadow: 0 0 8px rgba(0, 255, 136, 0.2); }
    .sidebar-item.flash-active { animation: pulse-green 0.5s; }
    .sidebar-item.agent-item.due { border-left: 3px solid var(--warning); }
    .edit-icon { opacity: 0; font-size: 10px; color: var(--text-muted); transition: opacity 0.2s; cursor: pointer; padding: 2px 4px; }
    .sidebar-item:hover .edit-icon { opacity: 1; }
    .edit-icon:hover { color: var(--accent); background: rgba(255,255,255,0.05); border-radius: 3px; }
    .crud-actions { display: flex; gap: 5px; flex-shrink: 0; }
    .crud-btn { font-size: 10px; padding: 6px 10px; background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; border-radius: 3px; }
    .crud-btn:hover { color: var(--accent); border-color: var(--accent); }
    .crud-btn.danger:hover { color: var(--error); border-color: var(--error); }
   
    .combo-console { display: flex; flex-direction: column; gap: 15px; height: 100%; }
    .console-toolbar { display: flex; gap: 10px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
    .console-btn { font-size: 11px; padding: 6px 12px; background: var(--bg-tertiary); color: var(--text-muted); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; }
    .console-btn:hover { color: var(--text-primary); border-color: var(--accent); }
    .console-btn.active { background: var(--accent-glow); color: var(--accent); border-color: var(--accent); }
    .drop-zone { flex: 1; background: var(--bg-tertiary); border: 2px dashed var(--border); border-radius: 6px; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
    .drop-zone.drag-over { border-color: var(--accent); background: rgba(0, 212, 255, 0.05); }
    .drag-item { background: var(--bg-secondary); border: 1px solid var(--border); padding: 8px 12px; border-radius: 4px; cursor: grab; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
    .drag-item:hover { border-color: var(--accent-dim); }
    .drag-item.in-sequence { border-left: 3px solid var(--accent); cursor: default; }
    .drag-palette { display: flex; flex-wrap: wrap; gap: 8px; max-height: 150px; overflow-y: auto; padding: 5px; border-bottom: 1px solid var(--border); }
    .palette-chip { font-size: 11px; padding: 4px 8px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; cursor: grab; user-select: none; }
    .palette-chip.cmd { color: var(--warning); border-color: rgba(255,170,0,0.3); }
    .palette-chip.ovr { color: var(--accent); border-color: var(--accent-glow); }
    .palette-chip.scramble { color: #d4aaff; border-color: rgba(212, 170, 255, 0.3); }
    .palette-chip.config { color: #ff88d4; border-color: rgba(255, 136, 212, 0.3); }
    .palette-chip.agent { color: #aaffaa; border-color: rgba(170, 255, 170, 0.3); }
    .remove-step { color: var(--error); cursor: pointer; font-weight: bold; padding: 0 5px; }
    .item-meta { font-size: 10px; color: var(--text-muted); margin-left: 8px; font-family: sans-serif; }
    .step-input { background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--accent); font-family: inherit; font-size: 11px; padding: 2px 5px; width: 60px; border-radius: 3px; text-align: center; }
    .step-input:focus { outline: none; border-color: var(--accent); }
    .step-select { background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); font-family: inherit; font-size: 11px; padding: 2px 5px; border-radius: 3px; }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">NEXUS v0.41</div>
    <div class="layout-controls">
      <button class="layout-btn" id="toggleSidebarBtn" title="Toggle Sidebar" onclick="window.safeToggle('sidebar')">◧</button>
      <button class="layout-btn" id="toggleWorkspaceBtn" title="Toggle Workspace" onclick="window.safeToggle('workspace')">◨</button>
      <div style="width:1px; background:var(--border); margin:0 5px;"></div>
      <button class="layout-btn" id="layoutPresetBtn" title="Layout Presets" onclick="window.cycleLayout()">⟐</button>
    </div>
    <div class="header-spacer"></div>
    <div class="indicator-chip" id="providerChip">
      <div class="dot"></div>
      <span>Setup Required</span>
    </div>
    <div class="indicator-chip" id="promptChip">
      <div class="dot"></div>
      <span>Kernel + Standard</span>
    </div>
    <button class="icon-btn stop-btn" id="stopComboBtn" title="Stop Sequence" style="display:none;" onclick="window.stopExecution()">■</button>
    <button class="icon-btn" id="workspaceToggle" title="Engineering Workspace" onclick="window.safeToggle('workspace')">⚒</button>
    <button class="icon-btn" id="powerBtn" title="Power Panel">⚡</button>
    <button class="icon-btn" id="helpBtn" title="Help">?</button>
    <button class="icon-btn" id="settingsToggle">⚙</button>
  </div>
 
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-grid">
      <div class="setting-group">
        <label class="setting-label">API Key <span class="auto-detect-link" id="autoDetectBtn">Auto-Detect</span></label>
        <input type="password" class="setting-input" id="apiKeyInput" placeholder="sk-...">
      </div>
      <div class="setting-group">
        <label class="setting-label">Provider</label>
        <select class="setting-select" id="providerSelect">
          <option value="auto" selected>Auto-Detect</option>
          <option value="anthropic">Anthropic</option>
          <option value="openai">OpenAI</option>
          <option value="groq">Groq</option>
          <option value="gemini">Google Gemini</option>
          <option value="openrouter">OpenRouter</option>
          <option value="xai">xAI</option>
        </select>
      </div>
      <div class="setting-group">
        <label class="setting-label">Model</label>
        <input type="text" class="setting-input" id="modelInput" placeholder="e.g. claude-sonnet-4-5">
      </div>
      <div class="setting-group">
        <label class="setting-label">Max Tokens</label>
        <input type="number" class="setting-input" id="maxTokensInput" value="8192">
      </div>
      <div class="setting-group">
        <label class="setting-label">CORS Proxy (Optional)</label>
        <select class="setting-select" id="corsProxySelect">
            <option value="none">None (Direct)</option>
            <option value="corsproxy">corsproxy.io (Public)</option>
        </select>
      </div>
    </div>
  </div>
  <div class="main-container">
    <div class="sidebar" id="sidebar">
      <div class="sidebar-content">
        <div class="sidebar-section">
          <div class="sidebar-section-header" id="overlaysHeader">
            <span>Overlays</span>
            <span class="toggle-icon">▼</span>
          </div>
          <div class="sidebar-section-content" id="overlaysContent">
            <div class="hint">Loading...</div>
          </div>
        </div>
       
        <div class="sidebar-section">
          <div class="sidebar-section-header" id="commandsHeader">
            <span>Commands</span>
            <span class="toggle-icon">▼</span>
          </div>
          <div class="sidebar-section-content" id="commandsContent">
            <div class="hint">Loading...</div>
          </div>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-header" id="combosHeader">
            <span>Combos</span>
            <span class="toggle-icon">▼</span>
          </div>
          <div class="sidebar-section-content" id="combosContent">
            <div class="hint">No combos saved</div>
          </div>
        </div>
       
        <div class="sidebar-section">
          <div class="sidebar-section-header" id="agentsHeader">
            <span>Agents</span>
            <span class="toggle-icon">▼</span>
          </div>
          <div class="sidebar-section-content" id="agentsContent">
            <div class="hint">No agents running</div>
          </div>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-header" id="sessionsHeader">
            <span>Sessions</span>
            <span class="toggle-icon">▼</span>
          </div>
          <div class="sidebar-section-content" id="sessionsContent">
            <div class="hint">Loading...</div>
          </div>
        </div>
      </div>
    </div>
   
    <div class="split-view">
      <div class="chat-pane" id="chatPane">
        <div class="chat-messages" id="chatMessages">
          <div class="welcome-screen">
            <div class="welcome-logo">NEXUS</div>
            <div class="welcome-version">v0.41 — Linear Safe</div>
            <div class="welcome-text">
              Engineering Console Upgrade.
              <br><br>
              <em style="font-size:12px; color:var(--text-muted)">Dependencies Resolved. Architect Online.</em>
            </div>
            <div class="api-form">
              <input type="password" class="api-form-input" id="welcomeApiKey" placeholder="Enter your API key to begin" onkeydown="window.handleWelcomeKey(event)">
              <button class="api-form-btn" id="welcomeConnectBtn" onclick="window.handleWelcomeConnect()">Connect</button>
            </div>
          </div>
        </div>
        <div class="toast" id="toast"></div>
        <div class="input-container">
          <div class="shelf-bar">
            <span id="shelfSummary">0 pinned items</span>
            <span id="tokenCount">~0 context tokens</span>
          </div>
          <div class="input-wrapper">
            <textarea class="message-input" id="messageInput" placeholder="Enter message... (Shift+Enter for new line)" onkeydown="window.handleChatKey(event)"></textarea>
            <button class="send-btn" id="sendBtn" onclick="window.sendMessage()">Send</button>
          </div>
        </div>
      </div>
      <div class="workspace-pane collapsed" id="workspacePane">
        <div class="workspace-header">
          <div class="workspace-title">Engineering Console</div>
          <button class="icon-btn" id="closeWorkspaceBtn" onclick="window.closeWorkspace()">×</button>
        </div>
        <div class="workspace-content" id="workspaceContent">
          <!-- Dynamic Content -->
        </div>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="promptModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Prompt Stack</div>
        <button class="modal-close" id="promptClose">×</button>
      </div>
      <div class="modal-body">
        <pre id="promptPreview" style="white-space: pre-wrap; font-family: inherit; color: var(--text-secondary);"></pre>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="powerModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Power Panel</div>
        <button class="modal-close" id="powerClose">×</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-muted);">Use the Agent Architect in the Workspace to schedule tasks.</p>
      </div>
    </div>
  </div>
  <script>
    (() => {
      'use strict';
      const $ = (id) => document.getElementById(id);
     
      // --- 1. STATE & DB (DEFINED FIRST) ---
      const state = {
        booted: false,
        db: null,
        currentSession: null,
        abortController: null,
        isStreaming: false,
        agents: [],
        config: { provider: 'auto', model: 'claude-sonnet-4-5', apiKey: '', maxTokens: 8192, sourcesText: '', corsProxy: 'none' },
        currentDate: '2025-12-15',
        packs: [],
        customItems: [],
        combos: [],
        itemIndex: new Map(),
        comboBuilderSteps: [],
        runningComboId: null,
        stopSignal: false
      };
     
      const DB_NAME = 'nexus-v0.32';
      const DB_VERSION = 3;
     
      const db = {
        async open() {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (e) => {
              const db = e.target.result;
              ['config', 'sessions', 'cache', 'agents', 'customItems', 'combos'].forEach(name => {
                if (!db.objectStoreNames.contains(name)) db.createObjectStore(name, { keyPath: name === 'config' ? 'key' : 'id' });
              });
            };
            request.onsuccess = (e) => { state.db = e.target.result; resolve(); };
            request.onerror = (e) => reject(e.target.error);
          });
        },
        async get(store, key) { return new Promise(r => { const req = state.db.transaction(store).objectStore(store).get(key); req.onsuccess = () => r(req.result); }); },
        async put(store, item) { return new Promise((resolve, reject) => { const req = state.db.transaction(store, 'readwrite').objectStore(store).put(item); req.onsuccess = () => resolve(); req.onerror = (e) => reject(e.target.error); }); },
        async delete(store, key) { return new Promise((resolve, reject) => { const req = state.db.transaction(store, 'readwrite').objectStore(store).delete(key); req.onsuccess = () => resolve(); req.onerror = (e) => reject(e.target.error); }); },
        async list(store, opts = {}) { return new Promise(r => { const results = []; const req = state.db.transaction(store).objectStore(store).openCursor(null, 'prev'); req.onsuccess = e => { const c = e.target.result; if (c && (!opts.limit || results.length < opts.limit)) { results.push(c.value); c.continue(); } else r(results); }; }); },
      };
      const el = {
        sidebar: $('sidebar'), providerChip: $('providerChip'), promptChip: $('promptChip'), powerBtn: $('powerBtn'), stopComboBtn: $('stopComboBtn'),
        toggleSidebarBtn: $('toggleSidebarBtn'), toggleWorkspaceBtn: $('toggleWorkspaceBtn'), layoutPresetBtn: $('layoutPresetBtn'), workspacePane: $('workspacePane'), closeWorkspaceBtn: $('closeWorkspaceBtn'), workspaceContent: $('workspaceContent'),
        settingsToggle: $('settingsToggle'), settingsPanel: $('settingsPanel'), providerSelect: $('providerSelect'), apiKeyInput: $('apiKeyInput'), autoDetectBtn: $('autoDetectBtn'), modelInput: $('modelInput'), maxTokensInput: $('maxTokensInput'), corsProxySelect: $('corsProxySelect'),
        welcomeApiKey: $('welcomeApiKey'), welcomeConnectBtn: $('welcomeConnectBtn'), messageInput: $('messageInput'), sendBtn: $('sendBtn'),
        toast: $('toast'), shelfSummary: $('shelfSummary'), tokenCount: $('tokenCount'), chatMessages: $('chatMessages'),
        sessionsContent: $('sessionsContent'), overlaysContent: $('overlaysContent'), commandsContent: $('commandsContent'), combosContent: $('combosContent'), agentsContent: $('agentsContent'), packsContent: $('packsContent'),
        promptModal: $('promptModal'), promptPreview: $('promptPreview'), powerModal: $('powerModal'), welcomeScreen: document.querySelector('.welcome-screen'), workspaceToggle: $('workspaceToggle')
      };
      // --- 2. CORE UTILS (DEFINED SECOND) ---
      function toast(msg, dur = 3000) { el.toast.textContent = msg; el.toast.classList.add('visible'); setTimeout(() => el.toast.classList.remove('visible'), dur); }
      function autosize() { el.messageInput.style.height = 'auto'; el.messageInput.style.height = Math.min(el.messageInput.scrollHeight, 200) + 'px'; }
      function escapeHtml(str) { return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
      function generateId() { return crypto.randomUUID(); }
      function estimateTokens(text) { return Math.ceil((text || '').length / 4); }
      function scrollToBottom() { el.chatMessages.scrollTop = el.chatMessages.scrollHeight; }
      function formatDate(iso) { return new Date(iso).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); }
      function getPinnedItems() { return state.currentSession?.context?.pinned || []; }
     
      // --- 3. CONFIG & LOADING LOGIC (DEFINED THIRD - BEFORE USE) ---
     
      const DEFAULT_ITEMS = [
        { id: 'overlay-standard', kind: 'overlay', title: 'Standard Kernel', body: 'You are a helpful, direct assistant.' },
        { id: 'overlay-coder', kind: 'overlay', title: 'Nexus Coder', body: 'You are an expert software engineer. Provide clean, efficient code with explanations.' },
        { id: 'overlay-writer', kind: 'overlay', title: 'Nexus Writer', body: 'You are a skilled creative writer. Use vivid, engaging language.' },
        { id: 'cmd-help', kind: 'command', title: '/help', body: 'Show available commands and usage' },
        { id: 'cmd-status', kind: 'command', title: '/status', body: 'Show current system status' }
      ];
      function detectProvider(key) {
        key = key.trim();
        if (key.startsWith('sk-ant')) return 'anthropic';
        if (key.startsWith('sk-or')) return 'openrouter';
        if (key.startsWith('gsk_')) return 'groq';
        if (key.startsWith('xai-')) return 'xai';
        if (key.startsWith('AIza')) return 'gemini';
        if (key.startsWith('sk-')) return 'openai';
        return 'auto';
      }
     
      function getDefaultModel(provider) {
        if (provider === 'groq') return 'llama-3.3-70b-versatile';
        if (provider === 'openai') return 'gpt-4o';
        if (provider === 'anthropic') return 'claude-sonnet-4-5';
        if (provider === 'xai') return 'grok-3';
        if (provider === 'gemini') return 'gemini-2.5-flash';
        return 'claude-sonnet-4-5';
      }
      async function saveConfig() {
        state.config.provider = el.providerSelect.value;
        state.config.model = el.modelInput.value.trim() || getDefaultModel(state.config.provider);
        state.config.maxTokens = parseInt(el.maxTokensInput.value) || 8192;
        state.config.apiKey = el.apiKeyInput.value.trim();
        state.config.corsProxy = el.corsProxySelect.value;
        await db.put('config', { key: 'main', ...state.config });
        updateProviderChip();
        renderChatArea();
      }
      async function loadConfig() {
        const saved = await db.get('config', 'main');
        if (saved) { state.config = { ...state.config, ...saved }; }
       
        el.providerSelect.value = state.config.provider;
        el.modelInput.value = state.config.model;
        el.maxTokensInput.value = state.config.maxTokens;
        el.apiKeyInput.value = state.config.apiKey || '';
        el.corsProxySelect.value = state.config.corsProxy || 'none';
       
        if (localStorage.getItem('nexus_sidebar') === 'closed') el.sidebar.classList.add('collapsed');
        if (localStorage.getItem('nexus_workspace') === 'closed') el.workspacePane.classList.add('collapsed');
        updateLayoutButtons();
        updateProviderChip();
        renderChatArea();
      }
      async function fetchPack(url) {
        const cached = await db.get('cache', url);
        if (cached && Date.now() - cached.fetchedAt < 3600000) return cached.data;
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          await db.put('cache', { url, fetchedAt: Date.now(), data });
          return data;
        } catch (e) { toast(`Failed to load pack: ${url}`); return null; }
      }
      async function loadPacks() {
        const urls = state.config.sourcesText.split('\n').map(u => u.trim()).filter(Boolean);
        const loaded = [];
        for (const url of urls) {
          const data = await fetchPack(url);
          if (data) loaded.push({ ...data, sourceUrl: url });
        }
        loaded.push({ id: 'nexus:core', name: 'Nexus Core Legacy', version: '1.0', items: [] });
        state.packs = loaded;
      }
      async function loadCustomItems() {
        let items = await db.list('customItems');
        if (items.length === 0) {
           for (const d of DEFAULT_ITEMS) await db.put('customItems', d);
           items = DEFAULT_ITEMS;
        }
        state.customItems = items;
        state.combos = await db.list('combos');
        rebuildItemIndex();
        renderSidebarLists();
      }
     
      async function loadAgents() {
        state.agents = await db.list('agents');
        renderAgents();
        updatePowerHeartbeat();
      }
      function rebuildItemIndex() {
        state.itemIndex.clear();
        state.packs.forEach(pack => { (pack.items||[]).forEach(item => state.itemIndex.set(`${pack.id}::${item.kind}::${item.id}`, item)); });
        state.customItems.forEach(i => state.itemIndex.set(i.id, i));
      }
     
      // --- 4. GLOBAL EXPORTS & UI LOGIC (DEFINED FOURTH) ---
     
      window.loadConfig = loadConfig; // Manual Global Export
      window.handleChatKey = (e) => {
         if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); window.sendMessage(); }
      };
     
      window.handleWelcomeKey = (e) => {
         if (e.key === 'Enter') { e.preventDefault(); window.handleWelcomeConnect(); }
      };
     
      window.handleWelcomeConnect = async () => {
          const key = el.welcomeApiKey.value.trim();
          if (key) {
             el.apiKeyInput.value = key;
             const detected = detectProvider(key);
             if (detected !== 'auto') {
                el.providerSelect.value = detected;
                el.modelInput.value = getDefaultModel(detected);
             }
             await saveConfig();
             if (!state.currentSession) await createNewSession();
             renderChatArea();
          } else {
             toast('Please enter a valid API Key');
          }
      };
      // --- 5. CHAT & RENDER LOGIC ---
      function renderChatArea() {
        if (state.config.apiKey && state.currentSession) {
          el.welcomeScreen.style.display = 'none';
        } else {
          el.welcomeScreen.style.display = 'flex';
        }
      }
      function updateProviderChip() {
        const hasKey = !!state.config.apiKey;
        el.providerChip.classList.toggle('connected', hasKey);
        el.providerChip.classList.toggle('error', !hasKey);
        el.providerChip.querySelector('span').textContent = hasKey ? `${state.config.provider.toUpperCase()} Ready` : 'Setup Required';
      }
     
      function updatePromptChip() {
        const overlayId = state.currentSession?.overlayId || 'overlay-standard';
        let item = state.itemIndex.get(overlayId);
        if(!item && state.customItems.length) item = state.customItems.find(i => i.id === 'overlay-standard') || state.customItems[0];
        const name = item?.title || 'Standard';
        el.promptChip.querySelector('span').textContent = `Kernel + ${name}`;
      }
      async function createNewSession() {
        const newSession = {
            id: generateId(),
            title: `Session ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            messages: [],
            overlayId: 'overlay-standard',
            context: { pinned: [] },
        };
        await db.put('sessions', newSession);
        state.currentSession = newSession;
        await renderSessionsList();
        renderChatArea();
        renderMessages();
        updatePromptChip();
        toast('New session created');
      }
      async function loadSession(id) {
        const session = await db.get('sessions', id);
        if (!session) return toast('Session not found');
        state.currentSession = session;
        await renderSessionsList();
        renderChatArea();
        renderMessages();
        updatePromptChip();
        renderSidebarLists();
        toast(`Loaded: ${session.title}`);
      }
     
      async function saveCurrentSession() {
        if (!state.currentSession) return;
        state.currentSession.updatedAt = new Date().toISOString();
        await db.put('sessions', state.currentSession);
        await renderSessionsList();
      }
      async function renderSessionsList() {
        const sessions = await db.list('sessions', { limit: 20 });
        if (sessions.length === 0) { el.sessionsContent.innerHTML = '<div class="hint">No saved sessions</div>'; return; }
        el.sessionsContent.innerHTML = sessions.map(s => `
            <div class="sidebar-item ${state.currentSession && s.id === state.currentSession.id ? 'active-item' : ''}" onclick="window.loadSession('${s.id}')">
              <div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(s.title)}</div>
              <div class="meta">${formatDate(s.updatedAt)}</div>
            </div>
        `).join('');
      }
      function composeSystemPrompt() {
        let prompt = `You are Nexus Terminal v0.41. Today is ${state.currentDate}. Be concise, honest, and capable.\n`;
        const overlayId = state.currentSession?.overlayId || 'overlay-standard';
        let item = state.itemIndex.get(overlayId);
        if (!item && state.customItems.length > 0) item = state.customItems.find(i => i.id === 'overlay-standard') || state.customItems[0];
       
        if (item) prompt += `=== OVERLAY: ${item.title} ===\n${item.body}\n\n`;
        else prompt += `=== OVERLAY: Standard ===\nYou are a helpful assistant.\n\n`;
       
        const pinned = getPinnedItems();
        if (pinned.length > 0) {
          prompt += `=== CONTEXT SHELF ===\n`;
          pinned.forEach(uid => { const p = state.itemIndex.get(uid); if(p) prompt += `\n-- ${p.title} --\n${p.body}\n`; });
        }
        return prompt.trim();
      }
      window.sendMessage = async () => {
        const text = el.messageInput.value.trim();
        if (!text || state.isStreaming) return;
        const userMsg = { role: 'user', content: text };
        state.currentSession.messages.push(userMsg);
        el.messageInput.value = '';
        autosize();
        renderMessages();
        await saveCurrentSession();
        const assistantMsg = { role: 'assistant', content: '', thinking: '' };
        state.currentSession.messages.push(assistantMsg);
        renderMessages();
        state.isStreaming = true;
        el.sendBtn.disabled = true;
        state.abortController = new AbortController();
        try {
          const apiMessages = state.currentSession.messages.filter(m => m.role !== 'assistant' || m.content);
          const system = composeSystemPrompt();
          // API Logic
          let url, body, headers = { 'content-type': 'application/json' };
          let effectiveProvider = state.config.provider === 'auto' ? detectProvider(state.config.apiKey) : state.config.provider;
          let effectiveModel = state.config.model || getDefaultModel(effectiveProvider);
          const maxTokens = parseInt(state.config.maxTokens) || 8192;
          if (effectiveProvider === 'anthropic') {
            url = 'https://api.anthropic.com/v1/messages';
            headers['x-api-key'] = state.config.apiKey;
            headers['anthropic-version'] = '2023-06-01';
            headers['anthropic-dangerous-direct-browser-access'] = 'true';
            body = { model: effectiveModel, system, messages: apiMessages.map(m=>({role:m.role,content:m.content})), max_tokens: maxTokens, stream: true };
          } else if (effectiveProvider === 'gemini') {
            let cleanModel = effectiveModel.replace(/^models\//, '').trim();
            url = `https://generativelanguage.googleapis.com/v1beta/models/${cleanModel}:streamGenerateContent?alt=sse&key=${state.config.apiKey}`;
            body = { contents: apiMessages.map(m=>({role: m.role==='assistant'?'model':'user', parts:[{text:m.content}]})), system_instruction:{parts:[{text:system}]}, generation_config:{max_output_tokens:maxTokens}};
          } else {
             url = 'https://api.openai.com/v1/chat/completions';
             if (effectiveProvider === 'groq') url = 'https://api.groq.com/openai/v1/chat/completions';
             if (effectiveProvider === 'openrouter') { url = 'https://openrouter.ai/api/v1/chat/completions'; headers['HTTP-Referer'] = window.location.href; }
             if (effectiveProvider === 'xai') url = 'https://api.x.ai/v1/chat/completions';
             headers['Authorization'] = `Bearer ${state.config.apiKey}`;
             body = { model: effectiveModel, messages: [{role:'system',content:system}, ...apiMessages.map(m=>({role:m.role,content:m.content}))], max_tokens: maxTokens, stream: true };
          }
          if (state.config.corsProxy === 'corsproxy') url = 'https://corsproxy.io/?' + encodeURIComponent(url);
          const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body), signal: state.abortController.signal });
          if (!res.ok) throw new Error(await res.text());
          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split('\n');
            for (const line of lines) {
              if (!line.startsWith('data: ')) continue;
              const data = line.slice(6);
              if (data === '[DONE]') continue;
              try {
                const event = JSON.parse(data);
                if (effectiveProvider === 'anthropic') {
                  if (event.type === 'content_block_delta' && event.delta.type === 'text_delta') assistantMsg.content += event.delta.text;
                } else if (effectiveProvider === 'gemini') {
                   const txt = event.candidates?.[0]?.content?.parts?.[0]?.text;
                   if(txt) assistantMsg.content += txt;
                } else {
                  const delta = event.choices?.[0]?.delta?.content;
                  if(delta) assistantMsg.content += delta;
                }
              } catch {}
            }
            renderMessages();
          }
        } catch (err) {
          if (err.name !== 'AbortError') {
             assistantMsg.content += `\n\n[Error: ${err.message}]`;
             toast('Transmission failed');
          }
        } finally {
          state.isStreaming = false;
          el.sendBtn.disabled = false;
          state.abortController = null;
          await saveCurrentSession();
          renderMessages();
        }
      };
      function renderMessages() {
        if (!state.currentSession) return;
        const msgs = state.currentSession.messages;
        if (msgs.length === 0) { el.chatMessages.innerHTML = '<div class="hint">Chat ready. Type a message or use a command.</div>'; return; }
       
        let html = '';
        msgs.forEach(msg => {
            const isUser = msg.role === 'user';
            html += `<div class="message ${isUser ? 'user' : 'assistant'}">
                <div class="message-header">${isUser ? 'You' : 'Nexus'}</div>
                <div class="message-content">${marked.parse(msg.content||'')}</div>
            </div>`;
        });
        el.chatMessages.innerHTML = html;
        scrollToBottom();
      }
      // --- WORKSPACE & COMBO LOGIC ---
      window.renderWorkspaceUI = (mode, target) => {
        el.workspacePane.classList.remove('collapsed');
        if(el.toggleWorkspaceBtn) el.toggleWorkspaceBtn.classList.add('active');
        if (mode === 'combo') { renderComboBuilder(); return; }
        if (mode === 'agent') { renderAgentBuilder(); return; }
        let item = { kind: target?.kind || 'overlay', title: '', body: '' };
        if (mode === 'edit') item = state.itemIndex.get(target) || item;
        el.workspaceContent.innerHTML = `
          <div class="console-toolbar">
             <button class="console-btn active">Item Editor</button>
             <button class="console-btn" onclick="window.renderWorkspaceUI('combo')">Combo Builder</button>
             <button class="console-btn" onclick="window.renderWorkspaceUI('agent')">Architect</button>
          </div>
          <div class="setting-group"><label class="setting-label">Type</label><select class="setting-select" id="wsKind" ${mode==='edit'?'disabled':''}><option value="overlay" ${item.kind==='overlay'?'selected':''}>Overlay</option><option value="command" ${item.kind==='command'?'selected':''}>Command</option></select></div>
          <div class="setting-group"><label class="setting-label">Title</label><input class="setting-input" id="wsTitle" value="${escapeHtml(item.title)}"></div>
          <div class="workspace-flex-grow"><label class="setting-label">Prompt</label><textarea class="setting-textarea" id="wsBody">${escapeHtml(item.body)}</textarea></div>
          <div class="crud-actions" style="margin-top:auto;"><button class="api-form-btn" id="wsSaveBtn" style="flex:1">Save</button>${mode==='edit'?`<button class="crud-btn danger" id="wsDeleteBtn" style="padding:0 15px">Delete</button>`:''}</div>
        `;
       
        $('wsSaveBtn').onclick = async () => {
          const newItem = { id: mode==='edit'?item.id:generateId(), kind: $('wsKind').value, title: $('wsTitle').value, body: $('wsBody').value };
          await db.put('customItems', newItem); await loadCustomItems(); toast('Item Saved');
        };
        if($('wsDeleteBtn')) $('wsDeleteBtn').onclick = async () => { if(confirm('Delete?')) { await db.delete('customItems', item.id); await loadCustomItems(); el.workspaceContent.innerHTML='<div class="hint">Deleted</div>'; } };
      };
      function renderAgentBuilder() {
         el.workspaceContent.innerHTML = `
          <div class="console-toolbar">
             <button class="console-btn" onclick="window.renderWorkspaceUI('create')">Item Editor</button>
             <button class="console-btn" onclick="window.renderWorkspaceUI('combo')">Combo Builder</button>
             <button class="console-btn active">Architect</button>
          </div>
          <div class="hint" style="text-align:left; padding:0 0 5px 0">1. Drag Combos to Sequence:</div>
          <div class="drag-palette" id="agentPalette">
             ${state.combos.map(c => `<div class="palette-chip agent" draggable="true" data-id="${c.id}" data-kind="combo">⚡ ${escapeHtml(c.title)}</div>`).join('')}
             <div class="palette-chip" draggable="true" data-id="wait-long" style="border-style:dashed">⏳ Wait 1h</div>
          </div>
          <div class="hint" style="text-align:left; padding:10px 0 5px 0">2. Agent Timeline:</div>
          <div class="drop-zone" id="agentDropZone"><div class="hint">Drop combos here</div></div>
          <div class="setting-group" style="margin-top:auto"><label class="setting-label">Schedule</label><select class="setting-select" id="agentSchedule"><option value="once">Run Once</option><option value="hourly">Hourly</option><option value="daily">Daily</option></select><button class="api-form-btn" id="saveAgentBtn" style="margin-top:5px;">Spawn Agent</button></div>
         `;
         // Drag & Drop logic for Agents would be similar to Combos, simplified for V1 safety
         setupAgentDrag();
      }
     
      // Global Helpers exposed
      window.activateOverlay = async (id, element) => {
        state.currentSession.overlayId = id; await saveCurrentSession(); updatePromptChip(); renderSidebarLists();
        toast('Overlay Activated');
        if(element) { element.classList.remove('flash-active'); void element.offsetWidth; element.classList.add('flash-active'); }
      };
     
      window.safeToggle = (id) => {
         const elem = $(id === 'sidebar' ? 'sidebar' : 'workspacePane');
         if(elem) elem.classList.toggle('collapsed');
         updateLayoutButtons();
         if (id === 'workspace' && !elem.classList.contains('collapsed') && !el.workspaceContent.querySelector('.setting-group')) window.renderWorkspaceUI('create');
      };
      window.closeWorkspace = () => { el.workspacePane.classList.add('collapsed'); updateLayoutButtons(); };
      window.cycleLayout = () => { /* ... toggling logic ... */ };
      function renderSidebarLists() {
        const overlays = state.customItems.filter(i => i.kind === 'overlay');
        el.overlaysContent.innerHTML = `<div class="sidebar-item" onclick="window.renderWorkspaceUI('create', {kind:'overlay'})" style="border:1px dashed var(--border); justify-content:center; opacity:0.7;">+ New Overlay</div>` +
          overlays.map(i => `<div class="sidebar-item ${state.currentSession?.overlayId===i.id?'active-item':''}" onclick="window.activateOverlay('${i.id}', this)"><span>${escapeHtml(i.title)}</span><span class="edit-icon" onclick="event.stopPropagation(); window.renderWorkspaceUI('edit', '${i.id}')">EDIT</span></div>`).join('');
        // ... (Commands & Combos similar logic) ...
      }
     
      function updateLayoutButtons() {
         el.toggleSidebarBtn.classList.toggle('active', !el.sidebar.classList.contains('collapsed'));
         el.toggleWorkspaceBtn.classList.toggle('active', !el.workspacePane.classList.contains('collapsed'));
      }
     
      // --- 6. BOOT SEQUENCE (LAST) ---
      async function boot() {
        try {
            state.isStreaming = false;
            if(el.sendBtn) el.sendBtn.disabled = false;
            await db.open();
           
            // Safe Loaders
            if (typeof loadConfig === 'function') await loadConfig();
            else console.warn("loadConfig missing");
            if (typeof loadPacks === 'function') await loadPacks();
            if (typeof loadCustomItems === 'function') await loadCustomItems();
           
            await loadAgents();
           
            const sessions = await db.list('sessions', { limit: 1 });
            if (sessions.length) await loadSession(sessions[0].id);
            else if (state.config.apiKey) await createNewSession();
           
            await renderSessionsList();
            renderAgents();
            renderChatArea();
            renderMessages();
            updatePromptChip();
            setupPowerPanel();
           
            // Wire basic UI events not handled inline
            if(el.settingsToggle) el.settingsToggle.onclick = () => el.settingsPanel.classList.toggle('visible');
            if(el.providerChip) el.providerChip.onclick = () => el.settingsPanel.classList.toggle('visible');
            if(el.powerBtn) el.powerBtn.onclick = () => el.powerModal.classList.add('visible');
            setInterval(() => {}, 30000); // Heartbeat
            toast('Nexus v0.41 — Linear Safe');
           
        } catch (err) {
            console.error(err);
            toast('Boot failed: ' + err.message);
        }
      }
     
      // Empty placeholders to prevent ReferenceError if not yet implemented fully in this block
      function setupPowerPanel() {}
      function updatePowerHeartbeat() {}
      function renderAgents() {}
      function renderComboBuilder() {}
      function setupAgentDrag() {}
      boot();
    })();
  </script>
</body>
</html>
